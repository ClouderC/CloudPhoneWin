var ae=Object.defineProperty;var oe=(a,e,t)=>e in a?ae(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var f=(a,e,t)=>oe(a,typeof e!="symbol"?e+"":e,t);import{br as Z}from"./index-DqYxAufE.js";var P={},B={},V;function he(){if(V)return B;V=1,Object.defineProperty(B,"__esModule",{value:!0});var a=function(){function e(t){this.data=t,this.index=0,this.bitLength=t.byteLength*8}return Object.defineProperty(e.prototype,"bitsAvailable",{get:function(){return this.bitLength-this.index},enumerable:!0,configurable:!0}),e.prototype.skipBits=function(t){if(this.bitsAvailable<t)throw new Error("no bytes available");this.index+=t},e.prototype.readBits=function(t){var r=this.getBits(t,this.index);return r},e.prototype.getBits=function(t,r,o){if(o===void 0&&(o=!0),this.bitsAvailable<t)throw new Error("no bytes available");var n=r%8,i=this.data[r/8|0]&255>>>n,h=8-n;if(h>=t)return o&&(this.index+=t),i>>h-t;o&&(this.index+=h);var s=t-h;return i<<s|this.getBits(s,r+h,o)},e.prototype.skipLZ=function(){var t;for(t=0;t<this.bitLength-this.index;++t)if(this.getBits(1,this.index+t,!1)!==0)return this.index+=t,t;return t},e.prototype.skipUEG=function(){this.skipBits(1+this.skipLZ())},e.prototype.skipEG=function(){this.skipBits(1+this.skipLZ())},e.prototype.readUEG=function(){var t=this.skipLZ();return this.readBits(t+1)-1},e.prototype.readEG=function(){var t=this.readUEG();return 1&t?1+t>>>1:-1*(t>>>1)},e.prototype.readBoolean=function(){return this.readBits(1)===1},e.prototype.readUByte=function(){return this.readBits(8)},e.prototype.readUShort=function(){return this.readBits(16)},e.prototype.readUInt=function(){return this.readBits(32)},e}();return B.default=a,B}var g={},z;function A(){if(z)return g;z=1,Object.defineProperty(g,"__esModule",{value:!0});var a,e;function t(i,h){a=i,e=h!=null?h:i}g.setLogger=t;function r(){return a!=null}g.isEnable=r;function o(i){for(var h=[],s=1;s<arguments.length;s++)h[s-1]=arguments[s];a&&a.apply(void 0,[i].concat(h))}g.log=o;function n(i){for(var h=[],s=1;s<arguments.length;s++)h[s-1]=arguments[s];e&&e.apply(void 0,[i].concat(h))}return g.error=n,g}var T={},G;function D(){if(G)return T;G=1,Object.defineProperty(T,"__esModule",{value:!0});var a=function(){function e(t){this.data=t,this.nri=(t[0]&96)>>5,this.ntype=t[0]&31}return Object.defineProperty(e,"NDR",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(e,"IDR",{get:function(){return 5},enumerable:!0,configurable:!0}),Object.defineProperty(e,"SEI",{get:function(){return 6},enumerable:!0,configurable:!0}),Object.defineProperty(e,"SPS",{get:function(){return 7},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PPS",{get:function(){return 8},enumerable:!0,configurable:!0}),Object.defineProperty(e,"TYPES",{get:function(){var t;return t={},t[e.IDR]="IDR",t[e.SEI]="SEI",t[e.SPS]="SPS",t[e.PPS]="PPS",t[e.NDR]="NDR",t},enumerable:!0,configurable:!0}),e.type=function(t){return t.ntype in e.TYPES?e.TYPES[t.ntype]:"UNKNOWN"},e.prototype.type=function(){return this.ntype},e.prototype.isKeyframe=function(){return this.ntype===e.IDR},e.prototype.getSize=function(){return 4+this.data.byteLength},e.prototype.getData=function(){var t=new Uint8Array(this.getSize()),r=new DataView(t.buffer);return r.setUint32(0,this.getSize()-4),t.set(this.data,4),t},e}();return T.default=a,T}var Y;function $(){if(Y)return P;Y=1,Object.defineProperty(P,"__esModule",{value:!0});var a=he(),e=A(),t=D(),r=function(){function o(n){this.remuxer=n,this.track=n.mp4track}return o.prototype.parseSEI=function(n){for(var i=o.readSEI(n),h=0,s=i;h<s.length;h++){var u=s[h];switch(u.type){case 0:this.track.seiBuffering=!0;break;case 5:return!0}}return!1},o.prototype.parseSPS=function(n){var i=o.readSPS(n);this.track.width=i.width,this.track.height=i.height,this.track.sps=[n],this.track.codec="avc1.";for(var h=new DataView(n.buffer,n.byteOffset+1,4),s=0;s<3;++s){var u=h.getUint8(s).toString(16);u.length<2&&(u="0"+u),this.track.codec+=u}},o.prototype.parsePPS=function(n){this.track.pps=[n]},o.prototype.parseNAL=function(n){if(!n)return!1;var i=!1;switch(n.type()){case t.default.NDR:case t.default.IDR:i=!0;break;case t.default.SEI:i=this.parseSEI(n.getData().subarray(4));break;case t.default.SPS:this.parseSPS(n.getData().subarray(4)),e.log(" Found SPS type NALU frame."),!this.remuxer.readyToDecode&&this.track.pps.length>0&&this.track.sps.length>0&&(this.remuxer.readyToDecode=!0);break;case t.default.PPS:this.parsePPS(n.getData().subarray(4)),e.log(" Found PPS type NALU frame."),!this.remuxer.readyToDecode&&this.track.pps.length>0&&this.track.sps.length>0&&(this.remuxer.readyToDecode=!0);break;default:e.log(" Found Unknown type NALU frame. type="+n.type());break}return i},o.skipScalingList=function(n,i){for(var h=8,s=8,u=0;u<i;u++){if(s!==0){var c=n.readEG();s=(h+c+256)%256}h=s===0?h:s}},o.readSPS=function(n){var i=this.parseSPS(n),h=i.pic_width_in_mbs_minus1,s=i.frame_crop_left_offset,u=i.frame_crop_right_offset,c=i.frame_mbs_only_flag,d=i.pic_height_in_map_units_minus1,l=i.frame_crop_top_offset,p=i.frame_crop_bottom_offset,x=i.sar,y=x[0]/x[1];return{width:Math.ceil(((h+1)*16-s*2-u*2)*y),height:(2-c)*(d+1)*16-(c?2:4)*(l+p)}},o.parseSPS=function(n){var i=new a.default(n),h=0,s=0,u=0,c=0;i.readUByte();var d=i.readUByte(),l=i.readUByte(),p=i.readBits(8),x=i.readUEG();if(d===100||d===110||d===122||d===244||d===44||d===83||d===86||d===118||d===128||d===138||d===139||d===134){var y=i.readUEG();if(y===3&&i.skipBits(1),i.skipUEG(),i.skipUEG(),i.skipBits(1),i.readBoolean())for(var _=y!==3?8:12,E=0;E<_;++E)i.readBoolean()&&(E<6?o.skipScalingList(i,16):o.skipScalingList(i,64))}i.skipUEG();var M=i.readUEG();if(M===0)i.readUEG();else if(M===1){i.skipBits(1),i.skipEG(),i.skipEG();for(var ee=i.readUEG(),E=0;E<ee;++E)i.skipEG()}i.skipUEG(),i.skipBits(1);var te=i.readUEG(),re=i.readUEG(),L=i.readBits(1);L===0&&i.skipBits(1),i.skipBits(1),i.readBoolean()&&(h=i.readUEG(),s=i.readUEG(),u=i.readUEG(),c=i.readUEG());var ie=i.readBoolean(),U=!1,m=[1,1];if(ie){if(U=i.readBoolean(),U){var N=i.readUByte();switch(N){case 1:m=[1,1];break;case 2:m=[12,11];break;case 3:m=[10,11];break;case 4:m=[16,11];break;case 5:m=[40,33];break;case 6:m=[24,11];break;case 7:m=[20,11];break;case 8:m=[32,11];break;case 9:m=[80,33];break;case 10:m=[18,11];break;case 11:m=[15,11];break;case 12:m=[64,33];break;case 13:m=[160,99];break;case 14:m=[4,3];break;case 15:m=[3,2];break;case 16:m=[2,1];break;case 255:{m=[i.readUByte()<<8|i.readUByte(),i.readUByte()<<8|i.readUByte()];break}default:e.error("  H264: Unknown aspectRatioIdc="+N)}}if(i.readBoolean()&&i.skipBits(1),i.readBoolean()&&(i.skipBits(4),i.readBoolean()&&i.skipBits(24)),i.readBoolean()&&(i.skipUEG(),i.skipUEG()),i.readBoolean())if(i.bitsAvailable>64){var O=i.readUInt(),H=i.readUInt(),se=i.readBoolean(),ne=H/(2*O);e.log("timescale: "+H+"; unitsInTick: "+O+"; "+("fixedFramerate: "+se+"; avgFrameDuration: "+ne))}else e.log("Truncated VUI ("+i.bitsAvailable+")")}return{profile_idc:d,constraint_set_flags:l,level_idc:p,seq_parameter_set_id:x,pic_width_in_mbs_minus1:te,pic_height_in_map_units_minus1:re,frame_mbs_only_flag:L,frame_crop_left_offset:h,frame_crop_right_offset:s,frame_crop_top_offset:u,frame_crop_bottom_offset:c,sar:m}},o.readSEI=function(n){var i=new a.default(n);i.skipBits(8);for(var h=[];i.bitsAvailable>3*8;)h.push(this.readSEIMessage(i));return h},o.readSEIMessage=function(n){function i(){for(var u=0;;){var c=n.readUByte();if(u+=c,c!==255)break}return u}var h=i(),s=i();return this.readSEIPayload(n,h,s)},o.readSEIPayload=function(n,i,h){var s;return s={type:i},n.skipBits(h*8),n.skipBits(n.bitsAvailable%8),s},o}();return P.default=r,P}var fe=$();const ue=Z(fe);function de(a){return a.toString(16).padStart(2,"0")}class be{constructor(){f(this,"canvas",null);f(this,"ctx",null);f(this,"decoder",null);f(this,"parent",null);f(this,"isPlaying",!1);f(this,"frameCounter",0);f(this,"lastFrameTime",0);f(this,"frameRate",0);f(this,"pendingFrames",0);f(this,"frameInterval",null);f(this,"videoWidth",0);f(this,"videoHeight",0);f(this,"keyFrameFound",!1);f(this,"buffer");f(this,"bufferedSPS",!1);f(this,"bufferedPPS",!1);f(this,"codecString","avc1.640028");f(this,"resizeHandler",null);f(this,"errorCount",0);f(this,"maxErrorCount",3);f(this,"reconnectTimer",null);f(this,"reconnectDelay",1e3);f(this,"NAL_TYPE_SPS",7);f(this,"NAL_TYPE_PPS",8);f(this,"NAL_TYPE_IDR",5);f(this,"NAL_TYPE_SEI",6);if(!("VideoDecoder"in window))throw new Error("当前浏览器不支持 WebCodecs API")}setParent(e){this.parent=e,this.canvas=document.createElement("canvas");const t={position:"absolute",left:"0",top:"0",width:"100%",height:"100%",display:"block",objectFit:"contain"};Object.assign(this.canvas.style,t),this.parent.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d",{alpha:!1,desynchronized:!0}),this.resizeHandler=this.handleResize.bind(this),window.addEventListener("resize",this.resizeHandler),this.videoWidth>0&&this.videoHeight>0&&this.handleResize()}handleResize(){var e,t;this.canvas&&this.videoWidth>0&&this.videoHeight>0&&((e=this.parent)!=null&&e.clientWidth||window.innerWidth,(t=this.parent)!=null&&t.clientHeight||window.innerHeight,this.canvas.width=this.videoWidth,this.canvas.height=this.videoHeight,this.canvas.style.width="100%",this.canvas.style.height="100%",this.ctx&&this.ctx.setTransform(1,0,0,1,0,0),this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.pendingFrames>0&&this.ctx&&this.canvas&&this.renderFrame())}renderFrame(){if(this.ctx&&this.canvas)try{this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.videoWidth>0&&this.videoHeight>0&&(this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height))}catch(e){console.error("【webcodecs】Canvas renderFrame 错误:",e)}}extractResolutionFromSPS(e){try{const t=ue.parseSPS(e),{profile_idc:r,constraint_set_flags:o,level_idc:n,pic_width_in_mbs_minus1:i,frame_crop_left_offset:h,frame_crop_right_offset:s,frame_mbs_only_flag:u,pic_height_in_map_units_minus1:c,frame_crop_top_offset:d,frame_crop_bottom_offset:l,sar:p}=t,x=p[0]/p[1];this.codecString=`avc1.${[r,o,n].map(de).join("")}`;const y=Math.ceil(((i+1)*16-h*2-s*2)*x),_=(2-u)*(c+1)*16-(u?2:4)*(d+l);y>0&&_>0&&(this.videoWidth=y,this.videoHeight=_,this.handleResize())}catch(t){console.error("【webcodecs】SPS解析错误:",t)}}initDecoder(){if(!(this.decoder&&this.decoder.state!=="closed"))try{this.decoder=new VideoDecoder({output:this.handleDecodedFrame.bind(this),error:e=>{console.error("【webcodecs】解码器错误:",e),this.errorCount++,this.isPlaying&&this.errorCount<=this.maxErrorCount?(this.closeDecoder(),this.reconnectTimer!==null&&clearTimeout(this.reconnectTimer),this.reconnectTimer=window.setTimeout(()=>{this.initDecoder(),this.reconnectTimer=null},this.reconnectDelay)):this.errorCount>this.maxErrorCount&&this.stop()}}),this.errorCount=0}catch(e){console.error("【webcodecs】解码器初始化失败:",e)}}closeDecoder(){if(this.decoder)try{this.decoder.state!=="closed"&&this.decoder.close(),this.decoder=null}catch(e){console.error("【webcodecs】关闭解码器错误:",e),this.decoder=null}}configureDecoder(){if(!(!this.decoder||this.decoder.state==="configured"))try{const e={codec:this.codecString,optimizeForLatency:!0};this.decoder.configure(e)}catch(e){console.error("【webcodecs】解码器配置失败:",e)}}handleDecodedFrame(e){this.pendingFrames--,this.frameCounter++;const t=performance.now();if(t-this.lastFrameTime>=1e3&&(this.frameRate=this.frameCounter,this.frameCounter=0,this.lastFrameTime=t),this.ctx&&this.canvas)try{const r=e.displayWidth,o=e.displayHeight;(this.videoWidth!==r||this.videoHeight!==o)&&r>0&&o>0&&(this.videoWidth=r,this.videoHeight=o,this.handleResize()),(this.videoWidth===0||this.videoHeight===0)&&(this.videoWidth=e.displayWidth,this.videoHeight=e.displayHeight,this.handleResize()),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(e,0,0,this.canvas.width,this.canvas.height)}catch(r){console.error("【webcodecs】Canvas drawImage 错误:",r)}e.close()}pushFrame(e){if(this.isPlaying){if(!this.decoder||this.decoder.state==="closed"){this.initDecoder();return}try{if(e.length<5)return;const t=e[4]&31;if(t===this.NAL_TYPE_SPS){this.extractResolutionFromSPS(e.subarray(4)),this.configureDecoder(),this.bufferedSPS=!0,this.buffer=this.appendToBuffer(e),this.keyFrameFound=!1;return}else if(t===this.NAL_TYPE_PPS){this.bufferedPPS=!0,this.buffer=this.appendToBuffer(e);return}else if(t===this.NAL_TYPE_SEI&&(!this.bufferedSPS||!this.bufferedPPS))return;const r=this.appendToBuffer(e);t===this.NAL_TYPE_IDR&&(this.keyFrameFound=!0),r&&this.decoder.state==="configured"&&this.keyFrameFound&&(this.buffer=void 0,this.bufferedPPS=!1,this.bufferedSPS=!1,this.decoder.decode(new EncodedVideoChunk({type:"key",timestamp:0,data:r})),this.pendingFrames++)}catch(t){console.error("【webcodecs】处理视频数据错误:",t)}}}appendToBuffer(e){let t;return this.buffer?(t=new Uint8Array(this.buffer.length+e.length),t.set(this.buffer),t.set(e,this.buffer.length)):t=e,t}play(){this.isPlaying||(this.isPlaying=!0,this.keyFrameFound=!1,this.bufferedSPS=!1,this.bufferedPPS=!1,this.buffer=void 0,this.errorCount=0,this.initDecoder())}stop(){this.isPlaying=!1,this.reconnectTimer!==null&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.frameInterval!==null&&(clearInterval(this.frameInterval),this.frameInterval=null),this.closeDecoder(),this.keyFrameFound=!1,this.bufferedSPS=!1,this.bufferedPPS=!1,this.buffer=void 0,this.errorCount=0;try{this.canvas&&(this.parent&&this.canvas.parentNode===this.parent?this.parent.removeChild(this.canvas):this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.ctx=null)}catch(e){console.warn("清理canvas元素时出错:",e)}if(this.resizeHandler)try{window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null}catch(e){console.warn("移除事件监听器时出错:",e)}}resize(){this.resizeHandler?this.resizeHandler():this.handleResize()}resetPlayerState(){if(this.keyFrameFound=!1,this.bufferedSPS=!1,this.bufferedPPS=!1,this.buffer=void 0,this.errorCount=0,this.pendingFrames=0,this.frameCounter=0,this.frameRate=0,this.lastFrameTime=performance.now(),this.decoder&&this.decoder.state==="configured")try{this.decoder.flush().catch(e=>{console.warn("【webcodecs】刷新解码器队列失败:",e)})}catch(e){console.warn("【webcodecs】重置解码器状态失败:",e)}this.ctx&&this.canvas&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}}var I={},C={},W;function ce(){if(W)return C;W=1,Object.defineProperty(C,"__esModule",{value:!0});var a=$(),e=A(),t=D(),r=1,o=function(){function n(i,h,s){this.fps=i,this.framePerFragment=h,this.timescale=s,this.readyToDecode=!1,this.totalDTS=0,this.stepDTS=Math.round(this.timescale/this.fps),this.frameCount=0,this.seq=1,this.mp4track={id:n.getTrackID(),type:"video",len:0,codec:"",sps:[],pps:[],seiBuffering:!1,width:0,height:0,timescale:s,duration:s,samples:[],isKeyFrame:!0},this.unitSamples=[[]],this.parser=new a.default(this)}return n.getTrackID=function(){return r++},Object.defineProperty(n.prototype,"seqNum",{get:function(){return this.seq},enumerable:!0,configurable:!0}),n.prototype.remux=function(i){if(this.mp4track.seiBuffering&&i.type()===t.default.SEI)return this.createNextFrame();if(this.parser.parseNAL(i)&&(this.unitSamples[this.unitSamples.length-1].push(i),this.mp4track.len+=i.getSize(),this.mp4track.isKeyFrame=i.isKeyframe()),!this.mp4track.seiBuffering&&(i.type()===t.default.IDR||i.type()===t.default.NDR))return this.createNextFrame()},n.prototype.createNextFrame=function(){if(this.mp4track.len>0){if(this.frameCount++,this.frameCount%this.framePerFragment===0){var i=this.getFragment();if(i){var h=this.totalDTS;return this.totalDTS=this.stepDTS*this.frameCount,[h,i]}else e.log("No mp4 sample data.")}this.unitSamples.push([])}},n.prototype.flush=function(){this.seq++,this.mp4track.len=0,this.mp4track.samples=[],this.mp4track.isKeyFrame=!1,this.unitSamples=[[]]},n.prototype.getFragment=function(){if(this.checkReadyToDecode()){var i=new Uint8Array(this.mp4track.len);this.mp4track.samples=[];for(var h=0,s=0,u=this.unitSamples.length;s<u;s++){var c=this.unitSamples[s];if(c.length!==0){for(var d={size:0,cts:this.stepDTS*s},l=0,p=c;l<p.length;l++){var x=p[l];d.size+=x.getSize(),i.set(x.getData(),h),h+=x.getSize()}this.mp4track.samples.push(d)}}if(h!==0)return i}},n.prototype.checkReadyToDecode=function(){return!this.readyToDecode||this.unitSamples.filter(function(i){return i.length>0}).length===0?(e.log("Not ready to decode! readyToDecode("+this.readyToDecode+") is false or units is empty."),!1):!0},n}();return C.default=o,C}var w={},q;function le(){if(q)return w;q=1,Object.defineProperty(w,"__esModule",{value:!0});var a=function(){function e(){}return e.init=function(){e.initalized=!0,e.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],styp:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trep:[],trex:[],tkhd:[],vmhd:[],smhd:[]};for(var t in e.types)e.types.hasOwnProperty(t)&&(e.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);var r=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),o=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),n=new Uint8Array([0,0,0,0,0,0,0,0]);e.STTS=e.STSC=e.STCO=n,e.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),e.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),e.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),e.STSD=new Uint8Array([0,0,0,0,0,0,0,1]),e.FTYP=e.box(e.types.ftyp,new Uint8Array([105,115,111,53,0,0,0,1,97,118,99,49,105,115,111,53,100,97,115,104])),e.STYP=e.box(e.types.styp,new Uint8Array([109,115,100,104,0,0,0,0,109,115,100,104,109,115,105,120])),e.DINF=e.box(e.types.dinf,e.box(e.types.dref,o)),e.HDLR=e.box(e.types.hdlr,r)},e.box=function(t){for(var r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];for(var n=8,i=0,h=r;i<h.length;i++){var s=h[i];n+=s.byteLength}var u=new Uint8Array(n);u[0]=n>>24&255,u[1]=n>>16&255,u[2]=n>>8&255,u[3]=n&255,u.set(t,4),n=8;for(var c=0,d=r;c<d.length;c++){var l=d[c];u.set(l,n),n+=l.byteLength}return u},e.mdat=function(t){return e.box(e.types.mdat,t)},e.mdhd=function(t){return e.box(e.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,85,196,0,0]))},e.mdia=function(t){return e.box(e.types.mdia,e.mdhd(t.timescale),e.HDLR,e.minf(t))},e.mfhd=function(t){return e.box(e.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]))},e.minf=function(t){return e.box(e.types.minf,e.box(e.types.vmhd,e.VMHD),e.DINF,e.stbl(t))},e.moof=function(t,r,o){return e.box(e.types.moof,e.mfhd(t),e.traf(o,r))},e.moov=function(t,r,o){for(var n=[],i=0,h=t;i<h.length;i++){var s=h[i];n.push(e.trak(s))}return e.box.apply(e,[e.types.moov,e.mvhd(o,r),e.mvex(t)].concat(n))},e.mvhd=function(t,r){var o=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2]);return e.box(e.types.mvhd,o)},e.mvex=function(t){for(var r=[],o=0,n=t;o<n.length;o++){var i=n[o];r.push(e.trex(i))}return e.box.apply(e,[e.types.mvex].concat(r,[e.trep()]))},e.trep=function(){return e.box(e.types.trep,new Uint8Array([0,0,0,0,0,0,0,1]))},e.stbl=function(t){return e.box(e.types.stbl,e.stsd(t),e.box(e.types.stts,e.STTS),e.box(e.types.stsc,e.STSC),e.box(e.types.stsz,e.STSZ),e.box(e.types.stco,e.STCO))},e.avc1=function(t){for(var r=[],o=[],n=0,i=t.sps;n<i.length;n++){var h=i[n],s=h.byteLength;r.push(s>>>8&255),r.push(s&255),r=r.concat(Array.prototype.slice.call(h))}for(var u=0,c=t.pps;u<c.length;u++){var h=c[u],s=h.byteLength;o.push(s>>>8&255),o.push(s&255),o=o.concat(Array.prototype.slice.call(h))}var d=e.box(e.types.avcC,new Uint8Array([1,r[3],r[4],r[5],255,224|t.sps.length].concat(r).concat([t.pps.length]).concat(o))),l=t.width,p=t.height;return e.box(e.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,p>>8&255,p&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,98,105,110,101,108,112,114,111,46,114,117,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),d,e.box(e.types.btrt,new Uint8Array([0,0,0,0,0,45,198,192,0,45,198,192])))},e.stsd=function(t){return e.box(e.types.stsd,e.STSD,e.avc1(t))},e.tkhd=function(t){var r=t.id,o=t.width,n=t.height;return e.box(e.types.tkhd,new Uint8Array([0,0,0,1,0,0,0,1,0,0,0,2,r>>24&255,r>>16&255,r>>8&255,r&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,t.type==="audio"?1:0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,o>>8&255,o&255,0,0,n>>8&255,n&255,0,0]))},e.traf=function(t,r){var o=t.id;return e.box(e.types.traf,e.box(e.types.tfhd,new Uint8Array([0,2,0,0,o>>24,o>>16&255,o>>8&255,o&255])),e.box(e.types.tfdt,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,r&255])),e.trun(t,72))},e.trak=function(t){return t.duration=t.duration||4294967295,e.box(e.types.trak,e.tkhd(t),e.mdia(t))},e.trex=function(t){var r=t.id;return e.box(e.types.trex,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,0,0,0,1,0,0,0,60,0,0,0,0,0,1,0,0]))},e.trun=function(t,r){var o=t.samples||[],n=o.length,i=t.isKeyFrame?4:0,h=12+i+4*n,s=new Uint8Array(h);r+=8+h,s.set([0,0,2,t.isKeyFrame?5:1,n>>>24&255,n>>>16&255,n>>>8&255,n&255,r>>>24&255,r>>>16&255,r>>>8&255,r&255],0),t.isKeyFrame&&s.set([0,0,0,0],12);for(var u=0;u<n;u++){var c=o[u],d=c.size;s.set([d>>>24&255,d>>>16&255,d>>>8&255,d&255],12+i+4*u)}return e.box(e.types.trun,s)},e.initSegment=function(t,r,o){e.initalized||e.init();var n=e.moov(t,r,o),i=new Uint8Array(e.FTYP.byteLength+n.byteLength);return i.set(e.FTYP),i.set(n,e.FTYP.byteLength),i},e.fragmentSegment=function(t,r,o,n){var i=e.moof(t,r,o),h=e.mdat(n),s=new Uint8Array(e.STYP.byteLength+i.byteLength+h.byteLength);return s.set(e.STYP),s.set(i,e.STYP.byteLength),s.set(h,e.STYP.byteLength+i.byteLength),s},e.types={},e.initalized=!1,e}();return w.default=a,w}var k={},j;function pe(){if(j)return k;j=1,Object.defineProperty(k,"__esModule",{value:!0});var a=D(),e=function(){function t(){}return t.prototype.clear=function(){this.buffer=void 0},t.prototype.append=function(r){var o=function(c){var d=3;return function(){for(var l=0;d<c.length;d++)switch(c[d]){case 0:l++;break;case 1:if(l===3)return d-3;default:l=0}}},n=[],i;this.buffer&&r[3]===1&&r[2]===0&&r[1]===0&&r[0]===0&&(n.push(new a.default(this.buffer.subarray(4))),i=Uint8Array.from(r)),i==null&&(i=this.mergeBuffer(r));for(var h=0,s=o(i),u=s();u!=null;u=s())n.push(new a.default(i.subarray(h+4,u))),h=u;return this.buffer=i.subarray(h),n},t.prototype.mergeBuffer=function(r){if(this.buffer==null)return Uint8Array.from(r);var o=new Uint8Array(this.buffer.byteLength+r.length);return this.buffer.byteLength>0&&o.set(this.buffer,0),o.set(r,this.buffer.byteLength),o},t}();return k.default=e,k}var K;function me(){return K||(K=1,function(a){Object.defineProperty(a,"__esModule",{value:!0});var e=ce(),t=le(),r=A(),o=pe();a.mimeType='video/mp4; codecs="avc1.42E01E"';var n=A();a.setLogger=n.setLogger;var i=function(){function h(s,u,c){if(u===void 0&&(u=60),c===void 0&&(c=u),this.element=s,this.fps=u,this.fpf=c,this.receiveBuffer=new o.default,this.queue=[],!MediaSource||!MediaSource.isTypeSupported(a.mimeType))throw new Error("Your browser is not supported: "+a.mimeType);this.reset()}return Object.defineProperty(h,"errorNotes",{get:function(){var s;return s={},s[MediaError.MEDIA_ERR_ABORTED]="fetching process aborted by user",s[MediaError.MEDIA_ERR_NETWORK]="error occurred when downloading",s[MediaError.MEDIA_ERR_DECODE]="error occurred when decoding",s[MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED]="audio/video not supported",s},enumerable:!0,configurable:!0}),h.prototype.setup=function(){var s=this;return this.mediaReadyPromise=new Promise(function(u,c){s.mediaSource.addEventListener("sourceopen",function(){r.log("Media Source opened."),s.sourceBuffer=s.mediaSource.addSourceBuffer(a.mimeType),s.sourceBuffer.addEventListener("updateend",function(){r.log("  SourceBuffer updateend"),r.log("    sourceBuffer.buffered.length="+s.sourceBuffer.buffered.length);for(var d=0,l=s.sourceBuffer.buffered.length;d<l;d++)r.log("    sourceBuffer.buffered ["+d+"]: "+(s.sourceBuffer.buffered.start(d)+", "+s.sourceBuffer.buffered.end(d)));if(r.log("  mediasource.duration="+s.mediaSource.duration),r.log("  mediasource.readyState="+s.mediaSource.readyState),r.log("  video.duration="+s.element.duration),r.log("    video.buffered.length="+s.element.buffered.length),r.isEnable())for(var d=0,l=s.element.buffered.length;d<l;d++)r.log("    video.buffered ["+d+"]: "+s.element.buffered.start(d)+", "+s.element.buffered.end(d));if(r.log("  video.currentTime="+s.element.currentTime),r.log("  video.readyState="+s.element.readyState),!s.sourceBuffer.updating){var p=s.queue.shift();p&&s.doAppend(p)}}),s.sourceBuffer.addEventListener("error",function(){r.error("  SourceBuffer errored!")}),s.mediaReady=!0,u()},!1),s.mediaSource.addEventListener("sourceclose",function(){r.log("Media Source closed."),s.mediaReady=!1},!1),s.element.src=URL.createObjectURL(s.mediaSource)}),this.mediaReadyPromise},h.prototype.play=function(){var s=this;if(this.element.paused)if(this.mediaReady&&this.element.readyState>=2)this.element.play();else{var u=function(){s.play(),s.element.removeEventListener("canplaythrough",u)};this.element.addEventListener("canplaythrough",u)}},h.prototype.pause=function(){this.element.paused||this.element.pause()},h.prototype.reset=function(){if(this.receiveBuffer.clear(),this.mediaSource&&this.mediaSource.readyState==="open"&&this.sourceBuffer.updating){var s=this.mediaSource;this.sourceBuffer.addEventListener("updateend",function(){s.endOfStream()})}this.mediaSource=new MediaSource,this.remuxer=new e.default(this.fps,this.fpf,this.fps*60),this.mediaReady=!1,this.mediaReadyPromise=void 0,this.queue=[],this.setup()},h.prototype.appendRawData=function(s){for(var u=this.receiveBuffer.append(s),c=0,d=u;c<d.length;c++){var l=d[c],p=this.remuxer.remux(l);p&&this.writeFragment(p[0],p[1])}},h.prototype.writeFragment=function(s,u){var c=this.remuxer;if(c.mp4track.isKeyFrame&&this.writeBuffer(t.default.initSegment([c.mp4track],1/0,c.timescale)),u&&u.byteLength){r.log(" Put fragment: "+c.seqNum+", frames="+c.mp4track.samples.length+", size="+u.byteLength);var d=t.default.fragmentSegment(c.seqNum,s,c.mp4track,u);this.writeBuffer(d),c.flush()}else r.error("Nothing payload!")},h.prototype.writeBuffer=function(s){var u=this;this.mediaReady?this.sourceBuffer.updating||this.queue.length?this.queue.push(s):this.doAppend(s):(this.queue.push(s),this.mediaReadyPromise&&(this.mediaReadyPromise.then(function(){if(!u.sourceBuffer.updating){var c=u.queue.shift();c&&u.doAppend(c)}}),this.mediaReadyPromise=void 0))},h.prototype.doAppend=function(s){var u=this.element.error;if(u)r.error("MSE Error Occured: "+h.errorNotes[u.code]),this.element.pause(),this.mediaSource.readyState==="open"&&this.mediaSource.endOfStream();else try{this.sourceBuffer.appendBuffer(s),r.log("  appended buffer: size="+s.byteLength)}catch(c){r.error("MSE Error occured while appending buffer. "+c.name+": "+c.message)}},h}();a.default=i}(I)),I}var R=me();const xe=Z(R),X=xe,ve=60,ye=1;class J{constructor(){f(this,"videoElement",null);f(this,"parent",null);f(this,"mediaSource",null);f(this,"sourceBuffer",null);f(this,"h264Converter",null);f(this,"isPlaying",!1);f(this,"mimeCodec",null);f(this,"spsNal",null);f(this,"ppsNal",null);f(this,"pendingFrames",[]);f(this,"sourceBufferUpdating",!1);f(this,"fps",ve);f(this,"fpf",ye);f(this,"momentumQualityStats");f(this,"inputBytes",[]);f(this,"videoStats",[]);f(this,"noDecodedFramesSince",-1);f(this,"currentTimeNotChangedSince",-1);f(this,"bigBufferSince",-1);f(this,"aheadOfBufferSince",-1);f(this,"lastTime",-1);f(this,"canPlay",!1);f(this,"seekingSince",-1);f(this,"inputFramesCount",0);f(this,"isPageVisible",!0);f(this,"lastBufferCheck",0);f(this,"blocks",[]);f(this,"waitUntilSegmentRemoved",!1);f(this,"frames",[]);f(this,"bufferThreshold",10);f(this,"forceRemoveBuffer",!1);f(this,"isSafari",!!window.safari);f(this,"isChrome",navigator.userAgent.includes("Chrome"));f(this,"isMac",navigator.platform.startsWith("Mac"));f(this,"MAX_TIME_TO_RECOVER",150);f(this,"MAX_BUFFER",this.isSafari?1.5:this.isChrome&&this.isMac?.7:.15);f(this,"MAX_AHEAD",-.15);f(this,"CHECK_INTERVAL",500);f(this,"VISIBILITY_CHECK_INTERVAL",2e3);f(this,"checkIntervalId",null);f(this,"visibilityCheckId",null);f(this,"resizeHandler",null);f(this,"videoErrorHandler",null);f(this,"videoCanPlayHandler",null);f(this,"handleSourceOpen",()=>{if(!this.mediaSource||!this.mimeCodec){console.error("[MsePlayer] MediaSource or MIME codec is null in handleSourceOpen.");return}if(this.mediaSource.sourceBuffers.length>0)this.sourceBuffer=this.mediaSource.sourceBuffers[0];else try{if(!MediaSource.isTypeSupported(this.mimeCodec)){console.error(`[MsePlayer] MIME type ${this.mimeCodec} is not supported.`);return}this.sourceBuffer=this.mediaSource.addSourceBuffer(this.mimeCodec),this.sourceBuffer.addEventListener("updateend",this.handleSourceBufferUpdateEnd),this.sourceBuffer.addEventListener("error",this.handleSourceBufferError),this.spsNal&&this.ppsNal?(this.h264Converter=new X(this.spsNal,this.ppsNal),this.appendConverterInitializationSegment(),this.flushPendingFrames()):console.warn("[MsePlayer] SPS/PPS not available when SourceBuffer opened. H264Converter not initialized yet.")}catch(e){console.error("[MsePlayer] Error adding SourceBuffer:",e)}});f(this,"handleSourceBufferUpdateEnd",()=>{this.sourceBufferUpdating=!1,this.flushPendingFrames()});f(this,"handleSourceBufferError",e=>{console.error("[MsePlayer] SourceBuffer error:",e),this.sourceBufferUpdating=!1});f(this,"cleanSourceBuffer",()=>{if(this.sourceBuffer){if(this.sourceBufferUpdating){console.warn("[MsePlayer] Skipping cleanSourceBuffer - SourceBuffer is updating");return}if(!(this.blocks.length<10)){if(this.seekingSince!==-1){console.warn("[MsePlayer] Skipping cleanSourceBuffer - Currently seeking"),setTimeout(()=>{this.seekingSince===-1&&this.blocks.length>=10&&this.cleanSourceBuffer()},100);return}try{this.sourceBuffer.removeEventListener("updateend",this.cleanSourceBuffer),this.waitUntilSegmentRemoved=!1;const e=this.blocks[0].start,t=this.blocks[4].end;this.blocks=this.blocks.slice(5),this.sourceBufferUpdating=!0,this.sourceBuffer.remove(e,t);let r=this.frames.shift();for(;r;){if(!this.checkForIFrame(r)){this.frames.unshift(r);break}r=this.frames.shift()}}catch(e){console.error("[MsePlayer] Failed to clean source buffer:",e),this.sourceBufferUpdating=!1}}}});f(this,"checkVideoResize",()=>{this.videoElement});f(this,"jumpEnd",-1);f(this,"jumpToEnd",()=>{if(!this.sourceBuffer||this.sourceBufferUpdating||!this.videoElement||!this.videoElement.buffered.length)return;const e=this.videoElement.buffered.end(this.videoElement.seekable.length-1);this.videoElement.currentTime=e,this.jumpEnd=-1,this.sourceBuffer.removeEventListener("updateend",this.jumpToEnd)});f(this,"handleVisibilityChange",()=>{const e=this.isPageVisible;this.isPageVisible=document.visibilityState==="visible",!e&&this.isPageVisible?(this.forceRemoveBuffer=!0,this.checkForBadState()):e&&this.isPageVisible});R.setLogger(()=>{},console.error),J.isSupported()||console.error("[MsePlayer] Browser does not support MediaSource API or the H.264 mime type."),document.addEventListener("visibilitychange",this.handleVisibilityChange),this.isPageVisible=document.visibilityState==="visible"}get videoWidth(){var e;return((e=this.videoElement)==null?void 0:e.videoWidth)||0}get videoHeight(){var e;return((e=this.videoElement)==null?void 0:e.videoHeight)||0}static isSupported(){try{return"MediaSource"in window&&MediaSource.isTypeSupported(R.mimeType)}catch(e){return console.error("Error checking MediaSource support:",e),!1}}setParent(e){this.parent=e,this.videoElement&&(this.videoErrorHandler&&this.videoElement.removeEventListener("error",this.videoErrorHandler),this.videoCanPlayHandler&&this.videoElement.removeEventListener("canplay",this.videoCanPlayHandler),this.videoElement.remove(),this.videoElement=null),this.videoElement=document.createElement("video"),this.videoElement.className="mse-video-player",this.videoElement.style.cssText="position:absolute; left:0; top:0; width:100%; height:100%; display:block; object-fit:contain; background-color:#000;",this.videoElement.muted=!0,this.videoElement.autoplay=!0,this.videoElement.setAttribute("muted","muted"),this.videoElement.setAttribute("autoplay","autoplay"),this.parent.appendChild(this.videoElement),this.videoErrorHandler=this.onVideoError.bind(this),this.videoCanPlayHandler=this.onVideoCanPlay.bind(this),this.videoElement.addEventListener("error",this.videoErrorHandler),this.videoElement.addEventListener("canplay",this.videoCanPlayHandler),this.videoElement.addEventListener("loadedmetadata",this.handleResize.bind(this)),this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=this.handleResize.bind(this),window.addEventListener("resize",this.resizeHandler),this.handleResize()}onVideoError(e){var t;console.error("[MsePlayer] Video Element Error:",e,(t=this.videoElement)==null?void 0:t.error)}onVideoCanPlay(){var e;(e=this.videoElement)==null||e.play().catch(t=>{console.warn("[MsePlayer] video.play() in onVideoCanPlay failed (might be ok if autoplay handled it):",t)}),this.handleResize(),this.canPlay=!0}handleResize(){!this.videoElement||this.parent}appendConverterInitializationSegment(){if(!this.h264Converter||!this.sourceBuffer||this.sourceBufferUpdating)return;const e=this.h264Converter.getInitializationSegment();if(e)try{this.sourceBufferUpdating=!0,this.sourceBuffer.appendBuffer(e)}catch(t){this.sourceBufferUpdating=!1,console.error("[MsePlayer] Error appending initialization segment:",t),t.name==="QuotaExceededError"&&this.clearSourceBuffer()}}appendFrameToSourceBuffer(e){if(!this.h264Converter||!this.sourceBuffer||this.sourceBufferUpdating||!this.isPlaying){this.sourceBufferUpdating||this.pendingFrames.push(e);return}const t=this.h264Converter.processFrame(e);if(t)try{this.sourceBufferUpdating=!0,this.sourceBuffer.appendBuffer(t),this.updateBlockInfo()}catch(r){this.sourceBufferUpdating=!1,console.error("[MsePlayer] Error appending frame to SourceBuffer:",r),r.name==="QuotaExceededError"&&(this.clearSourceBuffer(),this.pendingFrames.unshift(e))}}flushPendingFrames(){if(!(this.sourceBufferUpdating||!this.sourceBuffer||this.pendingFrames.length===0))for(;this.pendingFrames.length>0&&!this.sourceBufferUpdating;){const e=this.pendingFrames.shift();e&&this.appendFrameToSourceBuffer(e)}}clearSourceBuffer(){var e;if(this.sourceBuffer&&!this.sourceBufferUpdating){console.warn("[MsePlayer] Clearing SourceBuffer due to QuotaExceededError or explicit call.");try{const t=this.sourceBuffer.buffered;if(t.length>0){const r=((e=this.videoElement)==null?void 0:e.currentTime)||t.end(0),o=t.start(0);if(r>o){this.sourceBufferUpdating=!0;try{this.sourceBuffer.remove(o,r)}catch(n){console.error("[MsePlayer] Error removing buffer:",n)}}}}catch(t){console.error("[MsePlayer] Error while clearing SourceBuffer:",t),this.sourceBufferUpdating=!1}}}processPendingFrames(){let e=this.frames.shift();for(;e;){if(!this.checkForIFrame(e)){this.frames.unshift(e);break}e=this.frames.shift()}}updateBlockInfo(){if(!this.videoElement||!this.videoElement.buffered||!this.videoElement.buffered.length)return;const e=this.videoElement.buffered.start(0),t=this.videoElement.buffered.end(0);if(t!==0&&e<t){const r={start:e,end:t};(this.blocks.length===0||this.blocks[this.blocks.length-1].end!==t)&&this.blocks.push(r)}}checkForIFrame(e){if(!this.h264Converter)return!1;if(this.sourceBuffer=this.h264Converter.sourceBuffer,this.isIFrame(e)){let t=0,r=0;if(this.videoElement&&this.videoElement.buffered&&this.videoElement.buffered.length&&(t=this.videoElement.buffered.start(0),r=this.videoElement.buffered.end(0)),r!==0&&t<r){const o={start:t,end:r};if(this.blocks.push(o),this.blocks.length>10)return this.waitUntilSegmentRemoved=!0,this.sourceBuffer&&this.sourceBuffer.addEventListener("updateend",this.cleanSourceBuffer),this.h264Converter.appendRawData(e),!0}this.sourceBuffer&&(this.sourceBuffer.onupdateend=this.checkVideoResize)}return this.waitUntilSegmentRemoved?!1:(this.h264Converter.appendRawData(e),!0)}isIFrame(e){if(e.length>4){for(let t=0;t<e.length-4;t++)if(e[t]===0&&e[t+1]===0&&e[t+2]===0&&e[t+3]===1)return(e[t+4]&31)===5}return!1}getVideoPlaybackQuality(){if(!this.videoElement)return null;const e=this.videoElement,t=Date.now();if(typeof this.videoElement.getVideoPlaybackQuality=="function"){const r=this.videoElement.getVideoPlaybackQuality();return{timestamp:t,decodedFrames:r.totalVideoFrames,droppedFrames:r.droppedVideoFrames}}return typeof e.webkitDecodedFrameCount!="undefined"?{timestamp:t,decodedFrames:e.webkitDecodedFrameCount,droppedFrames:e.webkitDroppedFrameCount}:null}calculateMomentumStats(){const e=this.getVideoPlaybackQuality();if(!e)return;const t=Date.now(),r=t-1e3;for(this.videoStats.push(e);this.videoStats.length&&this.videoStats[0].timestamp<r;)this.videoStats.shift();for(;this.inputBytes.length&&this.inputBytes[0].timestamp<r;)this.inputBytes.shift();let o=0;this.inputBytes.forEach(i=>{o+=i.bytes});const n=this.inputBytes.length;if(this.videoStats.length){const i=this.videoStats[0],h=e.decodedFrames-i.decodedFrames,s=e.droppedFrames-i.droppedFrames;this.momentumQualityStats={decodedFrames:h,droppedFrames:s,inputBytes:o,inputFrames:n,timestamp:t}}}checkForBadState(){var o;if(!this.videoElement)return;const e=this.videoElement.currentTime,t=Date.now();let r=!1;if(this.momentumQualityStats&&(this.momentumQualityStats.decodedFrames===0&&this.momentumQualityStats.inputFrames>0?this.noDecodedFramesSince===-1?this.noDecodedFramesSince=t:t-this.noDecodedFramesSince>this.MAX_TIME_TO_RECOVER&&(r=!0):this.noDecodedFramesSince=-1),e===this.lastTime&&this.currentTimeNotChangedSince===-1?this.currentTimeNotChangedSince=t:this.currentTimeNotChangedSince=-1,this.lastTime=e,this.videoElement.buffered.length){const n=this.videoElement.buffered.end(0),i=n-e;if((n|0)-e>this.MAX_BUFFER?this.bigBufferSince===-1?this.bigBufferSince=t:t-this.bigBufferSince>this.MAX_TIME_TO_RECOVER&&(r=!0):this.bigBufferSince=-1,i<this.MAX_AHEAD?this.aheadOfBufferSince===-1?this.aheadOfBufferSince=t:t-this.aheadOfBufferSince>this.MAX_TIME_TO_RECOVER&&(r=!0):this.aheadOfBufferSince=-1,this.currentTimeNotChangedSince!==-1&&t-this.currentTimeNotChangedSince>this.MAX_TIME_TO_RECOVER&&(r=!0),!r)return;let h=0;if(this.seekingSince!==-1&&(h=t-this.seekingSince,h<1500))return;const s=()=>{var l,p;this.seekingSince=-1,(l=this.videoElement)==null||l.removeEventListener("seeked",s),(p=this.videoElement)==null||p.play().catch(x=>{console.warn("[MsePlayer] video.play() after seek failed:",x)})};if(this.seekingSince!==-1)if(console.warn(`[MsePlayer] Attempt to seek while already seeking! ${h}`),h>3e3)console.warn(`[MsePlayer] Force reset seeking state after ${h}ms`),this.seekingSince=-1,(o=this.videoElement)==null||o.removeEventListener("seeked",s);else return;this.seekingSince=t,this.videoElement.addEventListener("seeked",s);const u=setTimeout(()=>{var l;this.seekingSince!==-1&&(console.warn("[MsePlayer] Seek timeout, force reset seeking state"),this.seekingSince=-1,(l=this.videoElement)==null||l.removeEventListener("seeked",s))},5e3),c=s,d=()=>{clearTimeout(u),c()};this.videoElement.removeEventListener("seeked",s),this.videoElement.addEventListener("seeked",d),this.videoElement.currentTime=this.videoElement.buffered.end(0)}}pushFrame(e){this.inputBytes.push({timestamp:Date.now(),bytes:e.length}),this.inputBytes.length%10===0&&this.calculateMomentumStats(),!(!this.isPlaying||!this.h264Converter)&&(this.checkForIFrame(e)?this.checkForBadState():this.frames.push(e))}resetStats(){this.videoStats=[],this.inputBytes=[],this.momentumQualityStats=void 0}play(){if(!this.isPlaying){if(!this.parent||!this.videoElement){console.error("[MsePlayer] Parent or videoElement not set. Call setParent() first.");return}if(!this.h264Converter)try{this.h264Converter=new X(this.videoElement,this.fps,this.fpf)}catch(e){console.error("[MsePlayer] Failed to initialize H264Converter:",e),this.isPlaying=!1;return}typeof this.h264Converter.play=="function"?this.h264Converter.play():console.warn("[MsePlayer] h264Converter does not have a .play() method. Relying on autoplay."),this.isPlaying=!0,this.videoElement.play().catch(e=>{console.warn(`[MsePlayer] videoElement.play() encountered an issue (this is often normal): ${e.name} - ${e.message}`)}),this.lastTime=this.videoElement.currentTime,this.noDecodedFramesSince=-1,this.currentTimeNotChangedSince=-1,this.bigBufferSince=-1,this.aheadOfBufferSince=-1,this.seekingSince=-1,this.blocks=[],this.waitUntilSegmentRemoved=!1,this.inputFramesCount=0,this.lastBufferCheck=0,this.isPageVisible=document.visibilityState==="visible",this.checkIntervalId&&clearInterval(this.checkIntervalId),this.checkIntervalId=setInterval(()=>{this.checkForBadState()},this.CHECK_INTERVAL),this.visibilityCheckId&&clearInterval(this.visibilityCheckId),this.visibilityCheckId=setInterval(()=>{document.visibilityState==="visible"!==this.isPageVisible&&this.handleVisibilityChange()},this.VISIBILITY_CHECK_INTERVAL)}}stop(){if(this.isPlaying=!1,document.removeEventListener("visibilitychange",this.handleVisibilityChange),this.h264Converter)try{typeof this.h264Converter.appendRawData=="function"&&this.h264Converter.appendRawData(new Uint8Array([])),typeof this.h264Converter.pause=="function"&&this.h264Converter.pause()}catch(e){console.error("[MsePlayer] Error during H264Converter cleanup:",e)}this.videoElement&&this.videoElement.pause(),this.checkIntervalId&&(clearInterval(this.checkIntervalId),this.checkIntervalId=null),this.visibilityCheckId&&(clearInterval(this.visibilityCheckId),this.visibilityCheckId=null),this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null)}resetPlayerState(){if(this.seekingSince=-1,this.noDecodedFramesSince=-1,this.currentTimeNotChangedSince=-1,this.bigBufferSince=-1,this.aheadOfBufferSince=-1,this.sourceBufferUpdating=!1,this.waitUntilSegmentRemoved=!1,this.blocks=[],this.frames=[],this.pendingFrames=[],this.resetStats(),this.videoElement&&this.videoElement.buffered.length>0)try{this.videoElement.pause(),setTimeout(()=>{this.videoElement&&this.isPlaying&&this.videoElement.play().catch(e=>{console.warn("[MsePlayer] Failed to resume playback after reset:",e)})},100)}catch(e){console.warn("[MsePlayer] Error during video element reset:",e)}}forceReset(){if(this.seekingSince=-1,this.noDecodedFramesSince=-1,this.currentTimeNotChangedSince=-1,this.bigBufferSince=-1,this.aheadOfBufferSince=-1,this.sourceBufferUpdating=!1,this.waitUntilSegmentRemoved=!1,this.lastTime=-1,this.blocks=[],this.frames=[],this.pendingFrames=[],this.resetStats(),this.sourceBuffer&&!this.sourceBufferUpdating)try{const e=this.sourceBuffer.buffered;e.length>0&&(this.sourceBufferUpdating=!0,this.sourceBuffer.remove(e.start(0),e.end(e.length-1)))}catch(e){console.warn("[MsePlayer] Error during force buffer clear:",e),this.sourceBufferUpdating=!1}if(this.videoElement)try{this.videoElement.currentTime=0,this.isPlaying&&this.videoElement.play().catch(e=>{console.warn("[MsePlayer] Failed to restart playback after force reset:",e)})}catch(e){console.warn("[MsePlayer] Error during video element force reset:",e)}}get canvas(){return this.videoElement}}const ge={SYNC:{CANVAS_PORTRAIT:{WIDTH:352,HEIGHT:640},CANVAS_LANDSCAPE:{WIDTH:640,HEIGHT:352},EXPANDED_SCALE_FACTOR:3},PLAYER:{TYPE:"webcodecs",MSE:{FRAMES_PER_SECOND:15,FRAMES_PER_FRAGMENT:1,MULTI_INSTANCE:{ENABLED:!0,RESOURCE_LIMIT:.7,ADAPTIVE_QUALITY:!0,FRAME_DROP_THRESHOLD:15,AGGRESSIVE_MODE_THRESHOLD:8},BUFFER:{SAFARI_SIZE:2,CHROME_MAC_SIZE:1.5,DEFAULT_SIZE:.5,CLEAR_THRESHOLD:8,CLEAR_AMOUNT:4,RECOVERY_TIME:200}},WEBCODECS:{MAX_DECODER_QUEUE_SIZE:5}},VIDEO_SETTINGS:{BITRATE:5e5,MAX_FPS:25,I_FRAME_INTERVAL:5,BOUNDS:{WIDTH:960,HEIGHT:960},SEND_FRAME_META:!1,LOCKED_VIDEO_ORIENTATION:-1,DISPLAY_ID:0}},F={INITIAL:"scrcpy_initial",MESSAGE:"scrcpy_message"},S={DEVICE_MSG_TYPE_CLIPBOARD:0,CONNECTED:"connected",DISCONNECTED:"disconnected",ERROR:"error",VIDEO_SIZE:"videoSize",DEVICE_MESSAGE:"deviceMessage"};function Fe(a,e){const t=a instanceof ArrayBuffer?new Uint8Array(a):a;if(Q(t,F.INITIAL))return e.onInitialMessage&&e.onInitialMessage(t),!0;if(Q(t,F.MESSAGE)){if(e.onDeviceMessage&&t.length>F.MESSAGE.length){const r=t[F.MESSAGE.length];e.onDeviceMessage(t,r)}return!0}return!1}function Q(a,e){if(a.length<e.length)return!1;const t=new TextEncoder().encode(e);for(let r=0;r<t.length;r++)if(a[r]!==t[r])return!1;return!0}function _e(a,e=ge.VIDEO_SETTINGS,t){return a._videoSettingsSent?!1:(v(a,"videoSettings",{bitrate:e.BITRATE,maxFps:e.MAX_FPS,iFrameInterval:e.I_FRAME_INTERVAL,bounds:{width:e.BOUNDS.WIDTH,height:e.BOUNDS.HEIGHT},sendFrameMeta:e.SEND_FRAME_META,lockedVideoOrientation:e.LOCKED_VIDEO_ORIENTATION,displayId:e.DISPLAY_ID}),a._videoSettingsSent=!0,!0)}function Pe(a,e){if(e===S.DEVICE_MSG_TYPE_CLIPBOARD)try{const r=F.MESSAGE.length+1;if(a.length>=r+4){const o=a[r]<<24|a[r+1]<<16|a[r+2]<<8|a[r+3],n=r+4;if(a.length>=n+o){const i=a.slice(n,n+o),h=new TextDecoder("utf-8").decode(i);return{type:S.DEVICE_MESSAGE,messageType:"clipboard",text:h}}}}catch(t){console.error("解析剪贴板消息出错:",t)}return null}function v(a,e,t){if(!a||a.readyState!==WebSocket.OPEN){console.warn(`WebSocket连接不可用，无法发送${e}命令`);return}try{const r={type:e,data:t};a.send(JSON.stringify(r))}catch(r){console.error(`发送${e}命令失败:`,r)}}function Be(a,e){var t;if(!(!a||!a.type))switch(a.type){case S.VIDEO_SIZE:a.data&&e.onVideoSize&&e.onVideoSize(a.data.width,a.data.height,a.data.codec);break;case S.CONNECTED:e.onConnected&&e.onConnected(a.data);break;case S.DISCONNECTED:e.onDisconnected&&e.onDisconnected(a.message||"",a.data);break;case S.ERROR:e.onError&&e.onError(a.message||"",a.data);break;case S.DEVICE_MESSAGE:case"clipboard":(a.messageType==="clipboard"||a.type==="clipboard")&&e.onClipboard&&e.onClipboard(a.text||((t=a.data)==null?void 0:t.text)||"");break}}const Te={DOWN:0,UP:1,MOVE:2},Ce={DOWN:0,UP:1};function we(a,e,t,r){v(a,"touch",{action:e,x:t,y:r})}function ke(a,e,t,r=0,o=0){v(a,"keycode",{action:e,keycode:t,repeat:r,metaState:o})}function Ae(a,e){v(a,"text",{text:e})}function Ie(a){v(a,"getClipboard",{})}function Re(a,e,t=!1){v(a,"setClipboard",{text:e,paste:t})}function De(a,e,t=0){v(a,"keyCombination",{keycodes:e,metaState:t})}function Me(a,e){v(a,e,{})}const Le={DOWN:0,UP:1},b={SHIFT:1,ALT:2,CTRL:4096,META:65536,CAPS_LOCK:1048576};function Ue(a){const e={ArrowLeft:21,ArrowRight:22,ArrowUp:19,ArrowDown:20,Enter:66,Escape:111,Tab:61,Backspace:67,Delete:112,Home:122,End:123,PageUp:92,PageDown:93,Space:62,Comma:55,Period:56,Slash:76,Backslash:73,Semicolon:74,Quote:75,BracketLeft:71,BracketRight:72,Minus:69,Equal:70,Backquote:68,ShiftLeft:59,ShiftRight:60,ControlLeft:113,ControlRight:114,AltLeft:57,AltRight:58,MetaLeft:117,MetaRight:118,CapsLock:115,F1:131,F2:132,F3:133,F4:134,F5:135,F6:136,F7:137,F8:138,F9:139,F10:140,F11:141,F12:142};for(let t=0;t<=9;t++)e[`Digit${t}`]=t+7;for(let t=0;t<26;t++){const r=String.fromCharCode(65+t);e[`Key${r}`]=t+29}return e[a]}function Ne(a){let e=0;return a.shift&&(e|=b.SHIFT),a.alt&&(e|=b.ALT),a.ctrl&&(e|=b.CTRL),a.meta&&(e|=b.META),a.capsLock&&(e|=b.CAPS_LOCK),e}export{ge as D,Le as K,J as M,Te as T,be as W,Ae as a,ke as b,Pe as c,_e as d,Me as e,De as f,Ie as g,Fe as h,Be as i,Ne as j,we as k,Ce as l,Ue as m,Re as s};
