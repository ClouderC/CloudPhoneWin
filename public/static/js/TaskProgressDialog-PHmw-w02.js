var D=(w,x,s)=>new Promise((f,u)=>{var e=n=>{try{d(s.next(n))}catch(_){u(_)}},g=n=>{try{d(s.throw(n))}catch(_){u(_)}},d=n=>n.done?f(n.value):Promise.resolve(n.value).then(e,g);d((s=s.apply(w,x)).next())});import{a as j}from"./file-BLpzX1t2.js";import{h as J}from"./app-CvfiZxnR.js";import{v as L,r as y,A as T,o as O,as as W,a8 as R,U as V,q as v,R as l,p as k,E as S,H as a,D as r,S as i,Q as c,K as N,G as b,k as X,ab as Y,P as Z,F as ee,ae as te,_ as ae}from"./index-DqYxAufE.js";const se={key:0,class:"task-status-container"},le={class:"progress-container"},oe={class:"progress-text"},ne={key:0,class:"error-text"},re={key:1,class:"running-text"},ue={class:"dialog-footer"},ie=L({__name:"TaskProgressDialog",props:{visible:{type:Boolean},taskId:{},taskType:{default:"file"},autoRefresh:{type:Boolean,default:!0},refreshInterval:{default:2e3}},emits:["update:visible","update:taskStatus","close","refresh"],setup(w,{emit:x}){const s=w,f=x,u=y(s.visible),e=y(null),g=y(!1),d=y(null);T(()=>s.visible,t=>{u.value=t,t&&s.taskId?(n(),s.autoRefresh&&_()):p()}),T(u,t=>{f("update:visible",t),t||p()}),T(()=>s.taskId,t=>{t&&u.value?(n(),s.autoRefresh&&_()):p()}),O(()=>{s.visible&&s.taskId&&(n(),s.autoRefresh&&_())}),W(()=>{p()});const n=()=>D(null,null,function*(){if(s.taskId){g.value=!0;try{const o=yield(s.taskType==="app"?J:j)(s.taskId);o.code===0?(e.value=o.data,f("update:taskStatus",o.data),(o.data.status==="complete"||o.data.status==="failed")&&p()):R.error(o.message||"获取任务状态失败")}catch(t){console.error("获取任务状态出错:",t),R.error("获取任务状态出错"),p()}finally{g.value=!1}}}),_=()=>{p(),d.value=window.setInterval(n,s.refreshInterval)},p=()=>{d.value&&(clearInterval(d.value),d.value=null)},P=()=>{n(),f("refresh",e.value)},A=()=>{u.value=!1,f("update:visible",!1),f("close"),p()},E=t=>{switch(t){case"pending":return"等待执行";case"running":return"执行中";case"complete":return"已完成";case"failed":return"执行失败";default:return t}},M=t=>t.status==="failed"?"exception":t.status==="complete"?"success":"",U=t=>{switch(t){case"complete":return"success";case"failed":return"danger";case"running":return"warning";default:return"info"}};return(t,o)=>{const m=r("el-descriptions-item"),F=r("el-icon"),B=r("el-tag"),q=r("el-progress"),z=r("el-descriptions"),G=r("el-divider"),I=r("el-table-column"),H=r("el-table"),K=r("el-scrollbar"),C=r("el-button"),Q=r("el-dialog"),$=te("loading");return v(),V(Q,{modelValue:u.value,"onUpdate:modelValue":o[0]||(o[0]=h=>u.value=h),title:"任务进度",width:"600px"},{footer:l(()=>[b("span",ue,[a(C,{onClick:A},{default:l(()=>o[3]||(o[3]=[i("关闭")])),_:1}),a(C,{type:"primary",onClick:P,loading:g.value},{default:l(()=>o[4]||(o[4]=[i(" 刷新 ")])),_:1},8,["loading"])])]),default:l(()=>[e.value?(v(),k("div",se,[a(z,{column:2,border:""},{default:l(()=>[a(m,{label:"任务ID"},{default:l(()=>[i(c(e.value.taskId),1)]),_:1}),a(m,{label:"状态"},{default:l(()=>[a(B,{type:U(e.value.status),effect:e.value.status==="running"?"dark":"light",class:"status-tag"},{default:l(()=>[e.value.status==="running"?(v(),k(N,{key:0},[a(F,{class:"is-loading"},{default:l(()=>[a(X(Y))]),_:1}),o[1]||(o[1]=b("span",{class:"running-text"},"执行中",-1))],64)):(v(),k(N,{key:1},[i(c(E(e.value.status)),1)],64))]),_:1},8,["type","effect"])]),_:1}),a(m,{label:"总设备数"},{default:l(()=>[i(c(e.value.total),1)]),_:1}),a(m,{label:"已完成"},{default:l(()=>[i(c(e.value.completed),1)]),_:1}),a(m,{label:"失败数"},{default:l(()=>[b("span",{class:Z({"error-text":e.value.failed>0})},c(e.value.failed),3)]),_:1}),a(m,{label:"进度",span:2},{default:l(()=>[b("div",le,[a(q,{percentage:Math.round((e.value.completed+e.value.failed)/e.value.total*100),status:M(e.value),"stroke-width":20,"show-text":!1},null,8,["percentage","status"]),b("div",oe,[i(c(e.value.completed)+"/"+c(e.value.total)+" ",1),e.value.failed>0?(v(),k("span",ne,"(失败: "+c(e.value.failed)+")",1)):S("",!0),e.value.status==="running"?(v(),k("span",re,"正在执行...")):S("",!0)])])]),_:1})]),_:1}),a(G,{"content-position":"center"},{default:l(()=>o[2]||(o[2]=[i("设备列表")])),_:1}),a(K,{height:"300px"},{default:l(()=>[ee((v(),V(H,{data:e.value.results,style:{width:"100%"}},{default:l(()=>[a(I,{prop:"deviceId",label:"设备ID",width:"180","show-overflow-tooltip":""}),a(I,{prop:"status",label:"状态",width:"100"},{default:l(({row:h})=>[a(B,{type:h.status==="complete"?"success":"danger",effect:h.status==="complete"?"light":"dark"},{default:l(()=>[i(c(h.status==="complete"?"成功":"失败"),1)]),_:2},1032,["type","effect"])]),_:1}),a(I,{prop:"message",label:"信息","min-width":"200","show-overflow-tooltip":""})]),_:1},8,["data"])),[[$,e.value.status==="running"]])]),_:1})])):S("",!0)]),_:1},8,["modelValue"])}}}),_e=ae(ie,[["__scopeId","data-v-76145394"]]);export{_e as default};
