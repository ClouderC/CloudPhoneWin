var ie=Object.defineProperty,te=Object.defineProperties;var oe=Object.getOwnPropertyDescriptors;var L=Object.getOwnPropertySymbols;var se=Object.prototype.hasOwnProperty,ne=Object.prototype.propertyIsEnumerable;var w=(h,u,p)=>u in h?ie(h,u,{enumerable:!0,configurable:!0,writable:!0,value:p}):h[u]=p,O=(h,u)=>{for(var p in u||(u={}))se.call(u,p)&&w(h,p,u[p]);if(L)for(var p of L(u))ne.call(u,p)&&w(h,p,u[p]);return h},R=(h,u)=>te(h,oe(u));var x=(h,u,p)=>new Promise((D,g)=>{var E=m=>{try{A(p.next(m))}catch(d){g(d)}},l=m=>{try{A(p.throw(m))}catch(d){g(d)}},A=m=>m.done?D(m.value):Promise.resolve(m.value).then(E,l);A((p=p.apply(h,u)).next())});import{v as de,r as T,c as H,o as b,a8 as n,u as le,V,A as ve,C as ue,p as G,q as M,G as fe,U as W,E as Se,K as pe,L as Ae,P as Ie,aO as me,i as he,k as S,_ as Ee}from"./index-DqYxAufE.js";import{u as Ce}from"./cloudphone-BDuM8Wl3.js";import{D as t}from"./KeyboardMapping-D5a5ZElr.js";import De from"./MainDevicePlayer-CekhlvWP.js";import ge from"./SlaveDevicePlayer-DIvdWWf3.js";import{h as k,i as X}from"./device-MWnAPMey.js";const ye={class:"sync-container"},Ne=de({__name:"index",setup(h){me(e=>({"7fe861e6":S(t).SYNC.CANVAS_PORTRAIT.WIDTH/2+"px","5dd5a6ec":S(t).SYNC.CANVAS_LANDSCAPE.WIDTH/2+"px","1175e34f":E.value?S(t).SYNC.CANVAS_LANDSCAPE.WIDTH+"px":S(t).SYNC.CANVAS_PORTRAIT.WIDTH+"px","2b5c948b":E.value?S(t).SYNC.CANVAS_LANDSCAPE.WIDTH/2+"px":S(t).SYNC.CANVAS_PORTRAIT.WIDTH/2+"px",59579015:E.value?S(t).SYNC.CANVAS_LANDSCAPE.HEIGHT+"px":S(t).SYNC.CANVAS_PORTRAIT.HEIGHT+"px","6378e7a9":E.value?S(t).SYNC.CANVAS_LANDSCAPE.HEIGHT/2+"px":S(t).SYNC.CANVAS_PORTRAIT.HEIGHT/2+"px",d609c5ee:E.value?S(t).SYNC.CANVAS_LANDSCAPE.WIDTH/2*S(t).SYNC.EXPANDED_SCALE_FACTOR+"px":S(t).SYNC.CANVAS_PORTRAIT.WIDTH/2*S(t).SYNC.EXPANDED_SCALE_FACTOR+"px","7dac248d":E.value?S(t).SYNC.CANVAS_LANDSCAPE.HEIGHT/2*S(t).SYNC.EXPANDED_SCALE_FACTOR+"px":S(t).SYNC.CANVAS_PORTRAIT.HEIGHT/2*S(t).SYNC.EXPANDED_SCALE_FACTOR+"px"}));const u=le(),p=he(),D=Ce(),g=T("webcodecs"),E=H(()=>D.isLandscape),l=T([]),A=H(()=>l.value.find(e=>e.isMainDevice)),m=H(()=>l.value.filter(e=>!e.isMainDevice)),d=T(null),I=T([]),y=T(!0),Y=T(!1),_=T(null);b(()=>{const e=localStorage.getItem("cloudphone_decoderType");e&&["webcodecs","mse"].includes(e)?g.value=e:localStorage.setItem("cloudphone_decoderType",g.value),d.value});const q=e=>{var r,a;if(y.value=e,!((r=A.value)!=null&&r.isMainDevice)&&e){n.warning("只有主设备才能开启操作同步"),y.value=!1;return}e&&((a=A.value)!=null&&a.isMainDevice)?(n.success("操作同步已开启"),m.value.filter(c=>c.status==="online").length):n.info("操作同步已关闭")},F=e=>{if(!y.value)return;const r=I.value;if(!r||r.length===0)return;const a=E.value?t.SYNC.CANVAS_LANDSCAPE:t.SYNC.CANVAS_PORTRAIT,c=a.WIDTH,s=a.HEIGHT,v=Math.max(0,Math.min(e.x,c)),i=Math.max(0,Math.min(e.y,s)),f=v/c,o=i/s;r.forEach((C,N)=>{if(C&&C.getConnectionStatus()){let P,$;E.value?(P=t.SYNC.CANVAS_LANDSCAPE.WIDTH/2,$=t.SYNC.CANVAS_LANDSCAPE.HEIGHT/2):(P=t.SYNC.CANVAS_PORTRAIT.WIDTH/2,$=t.SYNC.CANVAS_PORTRAIT.HEIGHT/2);const re=Math.round(f*P),ce=Math.round(o*$);C.sendTouchEvent(e.action+1e4,re,ce)}})},B=e=>{if(!y.value)return;const r=I.value;!r||r.length===0||r.forEach(a=>{a&&a.getConnectionStatus()&&a.sendNavigation(e.type)})},K=e=>{if(!y.value)return;const r=I.value;!r||r.length===0||r.forEach(a=>{a&&a.getConnectionStatus()&&a.receiveSyncedKeyEvent(e.action,e.keyCode,e.repeat,e.metaState)})},U=e=>{if(!y.value)return;const r=I.value;!r||r.length===0||r.forEach(a=>{a&&a.getConnectionStatus()&&a.receiveSyncedTextEvent(e.text)})},z=e=>{console.error(`主设备 ${e.deviceId} 流错误:`,e.error)},j=e=>{console.error(`从设备 ${e.deviceId} 流错误:`,e.error)},J=e=>{},Q=e=>{},Z=e=>x(null,null,function*(){try{const r=l.value.find(c=>c.deviceId===e.deviceId);if(!r){console.warn(`[SyncPage] 无法找到要移除的设备: ${e.deviceId}`);return}const a=I.value.find(c=>c&&c.$el&&c.$el.getAttribute("data-device-id")===e.deviceId);if(a&&a.stopStream(),_.value===e.deviceId){_.value=null;const c=document.querySelector(".devices-grid");c&&c.classList.remove("has-expanded-device"),document.querySelectorAll(".device-card").forEach(s=>{s.classList.remove("dimmed")})}l.value=l.value.filter(c=>c.deviceId!==e.deviceId),D.setSelectedDevices(l.value),yield V();try{const c=yield X([e.deviceId]);c.code===0||console.warn(`[SyncPage] 设备 ${e.deviceId} 停止串流失败: ${c.message||"未知错误"}`)}catch(c){console.warn(`[SyncPage] 设备 ${e.deviceId} 停止串流异常:`,c)}if(l.value.length===0){n.warning("已移除所有设备，将返回设备列表页面"),u.push("/device/cloudphone");return}r.isMainDevice&&l.value.length>0&&(l.value[0].isMainDevice=!0,n.info(`已将设备 ${l.value[0].name||l.value[0].deviceId} 设置为新的主设备`)),I.value=I.value.filter(c=>c&&c.$el&&c.$el.getAttribute("data-device-id")!==e.deviceId),n.success(`已移除设备: ${r.name||e.deviceId}`)}catch(r){console.error("[SyncPage] 移除设备过程中发生错误:",r),n.error(`移除设备失败: ${r instanceof Error?r.message:"未知错误"}`)}}),ee=e=>x(null,null,function*(){try{const r=l.value.find(i=>i.deviceId===e.deviceId);if(!r){console.warn(`[SyncPage] 无法找到要设置为主设备的设备: ${e.deviceId}`);return}const a=l.value.find(i=>i.isMainDevice);if(r.isMainDevice){n.info(`设备 ${r.name||e.deviceId} 已经是主设备`);return}const c=[...l.value];if(c.forEach(i=>{i.isMainDevice=i.deviceId===e.deviceId}),c.sort((i,f)=>i.isMainDevice?-1:f.isMainDevice?1:0),_.value===e.deviceId){_.value=null;const i=document.querySelector(".devices-grid");i&&i.classList.remove("has-expanded-device"),document.querySelectorAll(".device-card").forEach(f=>{f.classList.remove("dimmed")})}D.setSelectedDevices(c),l.value=c,n.success(`已将设备 ${r.name||e.deviceId} 设置为主设备`),yield V();const s=[];d.value&&(typeof d.value.stopStream=="function"&&d.value.stopStream(),s.push(e.deviceId));const v=l.value.find(i=>!i.isMainDevice&&i.deviceId!==e.deviceId);if(v){const i=I.value.find(f=>f&&f.$el&&f.$el.getAttribute("data-device-id")===v.deviceId);i&&(typeof i.stopStream=="function"&&i.stopStream(),s.push(v.deviceId))}if(s.length>0)try{const i=yield k(s);if(i.code===0&&i.data&&i.data.results){const f=i.data.results;if(d.value&&f[e.deviceId]){const o=f[e.deviceId];o&&o.success&&o.port?setTimeout(()=>{var C,N;(C=d.value)==null||C.startStream(o.port),typeof((N=d.value)==null?void 0:N.updateVideoOrientation)=="function"&&setTimeout(()=>{var P;(P=d.value)==null||P.updateVideoOrientation()},500)},500):(console.error(`[SyncPage] 主设备 ${e.deviceId} 获取端口失败:`,(o==null?void 0:o.error)||"未知错误"),n.error(`主设备 ${e.deviceId} 获取端口失败: ${(o==null?void 0:o.error)||"未知错误"}`))}if(v&&f[v.deviceId]){const o=f[v.deviceId],C=I.value.find(N=>N&&N.$el&&N.$el.getAttribute("data-device-id")===v.deviceId);C&&o&&o.success&&o.port?setTimeout(()=>{C.startStream(o.port),typeof C.updateVideoOrientation=="function"&&setTimeout(()=>{C.updateVideoOrientation()},500)},1e3):(console.error(`[SyncPage] 从设备 ${v.deviceId} 获取端口失败:`,(o==null?void 0:o.error)||"未知错误"),n.error(`从设备 ${v.deviceId} 获取端口失败: ${(o==null?void 0:o.error)||"未知错误"}`))}}else console.error("[SyncPage] 批量启动API调用失败:",i),n.error("重新获取端口失败，请尝试手动刷新页面")}catch(i){console.error("[SyncPage] 批量启动API调用异常:",i),n.error("重新获取端口异常，请尝试手动刷新页面")}}catch(r){console.error("[SyncPage] 设置主设备过程中发生错误:",r),n.error(`设置主设备失败: ${r instanceof Error?r.message:"未知错误"}`)}}),ae=e=>{const r=I.value;!r||r.length===0||(_.value=e.expanded?e.deviceId:null,document.querySelector(".devices-grid"),e.expanded&&r.forEach(a=>{a&&a.isExpanded&&a.isExpanded()&&a.$el.getAttribute("data-device-id")!==e.deviceId&&a.collapse()}))};return b(()=>x(null,null,function*(){const e=D.selectedDevices;if(!e||e.length===0){n.warning("请先在分组手机页面选择需要同步的设备"),u.push({name:"CloudPhoneList"});return}l.value=e.map((a,c)=>R(O({},a),{isMainDevice:c===0})),yield V();const r=[];if(A.value&&A.value.status==="online"&&r.push(A.value.deviceId),m.value.forEach(a=>{a.status==="online"&&r.push(a.deviceId)}),r.length>0){Y.value=!0;try{const a=yield k(r);if(a.code===0&&a.data&&a.data.results){const c=a.data.results;if(A.value&&d.value){const s=c[A.value.deviceId];s&&s.success&&s.port?d.value.startStream(s.port):d.value.showError((s==null?void 0:s.error)||"主设备启动串流失败")}m.value.forEach(s=>{const v=c[s.deviceId],i=I.value.find(f=>f&&f.$el&&f.$el.getAttribute("data-device-id")===s.deviceId);i?v&&v.success&&v.port?i.startStream(v.port):i.showError((v==null?void 0:v.error)||`从设备 ${s.deviceId} 启动串流失败`):console.warn(`未找到设备 ${s.deviceId} 对应的 SlaveDevicePlayer 引用`)})}else n.error("批量启动串流API请求失败: "+(a.message||"未知错误")),d.value&&d.value.showError("批量启动API失败: "+(a.message||"未知错误")),I.value.forEach(c=>{c&&c.showError("批量启动API失败: "+(a.message||"未知错误"))})}catch(a){console.error("批量启动串流请求过程中发生错误:",a),n.error("批量启动串流请求失败: "+(a instanceof Error?a.message:"未知客户端错误")),d.value&&d.value.showError("批量启动请求错误: "+(a instanceof Error?a.message:"未知错误")),I.value.forEach(c=>{c&&c.showError("批量启动请求错误: "+(a instanceof Error?a.message:"未知错误"))})}finally{Y.value=!1}}})),ve(()=>p.path,()=>{(!D.selectedDevices||D.selectedDevices.length===0)&&(n.warning("请先在分组手机页面选择需要同步的设备"),u.push("/device/cloudphone"))}),ue(()=>x(null,null,function*(){var r;const e=[];if((r=A.value)!=null&&r.deviceId&&e.push(A.value.deviceId),m.value.forEach(a=>{a.deviceId&&e.push(a.deviceId)}),e.length>0)try{const a=yield X(e);a.code===0?n.info(`已发送批量停止 ${e.length} 个设备串流的请求。`):(console.error("批量停止串流API调用失败:",a.message),n.error("批量停止串流失败: "+(a.message||"未知错误")))}catch(a){console.error("调用批量停止串流API时发生代码错误:",a),n.error("批量停止串流时发生错误: "+(a instanceof Error?a.message:"未知客户端错误"))}})),(e,r)=>(M(),G("div",ye,[fe("div",{class:Ie(["devices-grid",{"landscape-mode":E.value}])},[A.value?(M(),W(De,{key:A.value.deviceId,device:A.value,"is-main-device":!0,"sync-enabled":y.value,"preferred-decoder-type":g.value,onSyncChange:q,onTouchEvent:F,onNavigationEvent:B,onKeyEvent:K,onTextEvent:U,onStreamError:z,onStreamSuccess:J,ref_key:"mainDevicePlayerRef",ref:d},null,8,["device","sync-enabled","preferred-decoder-type"])):Se("",!0),(M(!0),G(pe,null,Ae(m.value,a=>(M(),W(ge,{key:a.deviceId,device:a,"preferred-decoder-type":g.value,onStreamError:j,onStreamSuccess:Q,onExpansionChange:ae,onRemoveDevice:Z,onSetAsMain:ee,ref_for:!0,ref_key:"slaveDevicePlayerRefs",ref:I},null,8,["device","preferred-decoder-type"]))),128))],2)]))}}),Ve=Ee(Ne,[["__scopeId","data-v-6a13b253"]]);export{Ve as default};
