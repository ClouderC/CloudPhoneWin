var w=(C,G,R)=>new Promise((s,P)=>{var U=n=>{try{b(R.next(n))}catch(a){P(a)}},g=n=>{try{b(R.throw(n))}catch(a){P(a)}},b=n=>n.done?s(n.value):Promise.resolve(n.value).then(U,g);b((R=R.apply(C,G)).next())});import{v as Me,c as We,r as p,bs as $e,A as Re,o as He,C as xe,p as W,q as E,P as Ve,G as y,H as u,R as v,Q as Z,D as V,U as de,k as N,aN as Ye,bv as Le,O as ue,K as ze,E as X,ab as Ke,bu as ve,S as $,aH as Be,aO as Xe,a8 as Ge,V as ee,_ as Ue}from"./index-DqYxAufE.js";import{D as f,T as Y,k as fe,e as Fe,b as je,m as pe,l as ye,a as Je,i as qe,h as Qe,j as Ze,W as et,M as tt,c as at}from"./KeyboardMapping-D5a5ZElr.js";import{u as ot}from"./cloudphone-BDuM8Wl3.js";import{i as lt,h as st}from"./device-MWnAPMey.js";const nt=["data-device-id"],it={class:"device-header"},rt={class:"device-info"},ct={class:"device-name"},dt={class:"device-screen"},ut=["id"],vt={key:0,class:"video-loading-overlay"},ft={key:2,class:"stream-error"},pt={class:"error-content-wrapper"},yt={class:"error-text"},St={key:1,class:"offline-placeholder"},mt={class:"image-error"},ht={class:"device-footer"},Ct={class:"device-id"},It={class:"device-actions"},gt=Me({__name:"SlaveDevicePlayer",props:{device:{type:Object,required:!0},preferredDecoderType:{type:String,default:"webcodecs"}},emits:["stream-error","stream-success","expansion-change","remove-device","set-as-main"],setup(C,{expose:G,emit:R}){Xe(e=>({"01ae39d5":N(f).SYNC.CANVAS_PORTRAIT.WIDTH/2+"px","79fee642":N(f).SYNC.CANVAS_PORTRAIT.HEIGHT/2+"px"}));const s=C,P=R,U=ot(),g=We(()=>U.isLandscape),b=p(null),n=p(null),a=p(null),c=p(null),_=p(!1),k=p(!0),H=p({x:0,y:0}),te=p({x:0,y:0}),A=p(!1),D=p(!1),m=p({shift:!1,ctrl:!1,alt:!1,meta:!1,capsLock:!1}),I=p(!1),F=(e,t)=>{const o=f.VIDEO_SETTINGS;return{type:"videoSettings",data:{bitrate:o.BITRATE,maxFps:e,iFrameInterval:o.I_FRAME_INTERVAL,bounds:{width:o.BOUNDS.WIDTH,height:o.BOUNDS.HEIGHT},sendFrameMeta:o.SEND_FRAME_META,lockedVideoOrientation:t,displayId:o.DISPLAY_ID}}},j=()=>{if(I.value=!I.value,setTimeout(()=>{if(n.value&&(b.value||document.getElementById(`player-container-${s.device.deviceId}`)))try{typeof n.value.handleResize=="function"?n.value.handleResize():console.warn("[SlaveDevicePlayer] Player does not have a handleResize method.")}catch(t){console.warn("调整播放器大小失败:",t)}},100),P("expansion-change",{deviceId:s.device.deviceId,expanded:I.value}),a.value&&a.value.readyState===WebSocket.OPEN){const e=f.VIDEO_SETTINGS,t=g.value?1:0,o=I.value?e.MAX_FPS||25:5,l=F(o,t);a.value.send(JSON.stringify(l))}},ae=()=>{if(a.value&&a.value.readyState===WebSocket.OPEN){const e=g.value?1:0,t=F(5,e);a.value.send(JSON.stringify(t))}},Se=$e(()=>{ae()},300);Re(g,(e,t)=>{e!==t&&(n.value&&typeof n.value.resetPlayerState=="function"&&n.value.resetPlayerState(),Se())});const me=e=>{var o;const t=(o=e.currentTarget.parentElement)==null?void 0:o.parentElement;t&&(t.focus(),D.value=!0),A.value=!0,te.value={x:e.offsetX,y:e.offsetY},H.value={x:e.offsetX,y:e.offsetY},O(Y.DOWN,e.offsetX,e.offsetY)},he=e=>{A.value&&(H.value={x:e.offsetX,y:e.offsetY},O(Y.MOVE,e.offsetX,e.offsetY))},oe=e=>{A.value&&(A.value=!1,O(Y.UP,e.offsetX,e.offsetY))},Ce=e=>{e.preventDefault(),A.value=!0;const t=e.touches[0],l=e.target.getBoundingClientRect(),r=t.clientX-l.left,d=t.clientY-l.top;te.value={x:r,y:d},H.value={x:r,y:d},O(Y.DOWN,r,d)},Ie=e=>{if(e.preventDefault(),!A.value)return;const t=e.touches[0],l=e.target.getBoundingClientRect(),r=t.clientX-l.left,d=t.clientY-l.top;H.value={x:r,y:d},O(Y.MOVE,r,d)},ge=e=>{e.preventDefault(),A.value&&(A.value=!1,O(Y.UP,H.value.x,H.value.y))},O=(e,t,o)=>{if(!a.value||a.value.readyState!==WebSocket.OPEN){console.warn("WebSocket连接不可用，无法发送触摸事件");return}let l,r;if(g.value?(l=f.SYNC.CANVAS_LANDSCAPE.WIDTH/2,r=f.SYNC.CANVAS_LANDSCAPE.HEIGHT/2):(l=f.SYNC.CANVAS_PORTRAIT.WIDTH/2,r=f.SYNC.CANVAS_PORTRAIT.HEIGHT/2),n.value){const S=n.value;S.videoWidth&&S.videoHeight&&(l=S.videoWidth,r=S.videoHeight)}if(e>=1e4){const S=e-1e4;let z,Q;g.value?(z=f.SYNC.CANVAS_LANDSCAPE.WIDTH/2,Q=f.SYNC.CANVAS_LANDSCAPE.HEIGHT/2):(z=f.SYNC.CANVAS_PORTRAIT.WIDTH/2,Q=f.SYNC.CANVAS_PORTRAIT.HEIGHT/2);const ke=Math.round(t*(l/z)),Oe=Math.round(o*(r/Q));fe(a.value,S,ke,Oe);return}let d,i;g.value?(d=f.SYNC.CANVAS_LANDSCAPE.WIDTH/2,i=f.SYNC.CANVAS_LANDSCAPE.HEIGHT/2):(d=f.SYNC.CANVAS_PORTRAIT.WIDTH/2,i=f.SYNC.CANVAS_PORTRAIT.HEIGHT/2),I.value&&(d*=f.SYNC.EXPANDED_SCALE_FACTOR,i*=f.SYNC.EXPANDED_SCALE_FACTOR);const T=l/d,M=r/i,L=Math.round(t*T),h=Math.round(o*M);fe(a.value,e,L,h)},K=e=>{if(!a.value||a.value.readyState!==WebSocket.OPEN){Ge.warning("设备连接不可用，无法发送命令");return}Fe(a.value,e)},_e=()=>K("home"),Te=()=>K("back"),Ee=()=>{K("overview")},le=e=>{switch(e){case"removeDevice":x(!0),P("remove-device",{deviceId:s.device.deviceId});break;case"setAsMain":P("set-as-main",{deviceId:s.device.deviceId});break;default:console.warn(`未知的设备命令: ${e}`)}},Ae=(e,t)=>{if(!t.isClosed){if(typeof e.data=="string"){try{const o=JSON.parse(e.data);qe(o,{onVideoSize:(l,r)=>{n.value&&(n.value.videoWidth=l,n.value.videoHeight=r)},onConnected:l=>{},onDisconnected:l=>{console.warn(`从设备 ${s.device.deviceId} 连接已断开:`,l)},onError:l=>{console.error(`从设备 ${s.device.deviceId} 连接错误:`,l),c.value=l||"未知错误"}})}catch(o){}return}if(e.data instanceof ArrayBuffer&&!Qe(e.data,{onInitialMessage:l=>{if(!t._videoSettingsSent){const r=g.value?1:0,d=F(5,r);t.send(JSON.stringify(d)),t._videoSettingsSent=!0}},onDeviceMessage:(l,r)=>{at(l,r)}})){_.value||(_.value=!0,P("stream-success",s.device.deviceId));try{if(!n.value)return;const l=new Uint8Array(e.data);n.value.pushFrame(l)}catch(l){console.error(`设备 ${s.device.deviceId} 处理视频帧出错:`,l)}}}},J=()=>w(null,null,function*(){n.value&&(n.value.stop(),n.value=null);const e=`player-container-${s.device.deviceId}`,t=b.value||document.getElementById(e);if(!t)return console.error(`[SlaveDevicePlayer ${s.device.deviceId}] Player container #${e} is not available.`),c.value="播放器容器丢失",!1;let o,l="";if(s.preferredDecoderType==="webcodecs"&&window.VideoDecoder)o=et,l="WebCodecs";else if(s.preferredDecoderType==="mse"||!window.VideoDecoder)o=tt,l="MSE",s.preferredDecoderType==="webcodecs"&&!window.VideoDecoder&&console.warn(`[SlaveDevicePlayer ${s.device.deviceId}] WebCodecs not supported, falling back to MSE.`);else return console.error(`[SlaveDevicePlayer ${s.device.deviceId}] Unknown or unsupported decoder type: ${s.preferredDecoderType}`),c.value=`不支持的解码器: ${s.preferredDecoderType}`,!1;try{return n.value=new o,n.value.setParent(t),_.value=!1,!0}catch(r){return console.error(`[SlaveDevicePlayer ${s.device.deviceId}] Error initializing ${l} player:`,r),c.value=`${l} 播放器初始化失败: ${r instanceof Error?r.message:"未知错误"}`,n.value=null,!1}}),se=(e,t)=>w(null,null,function*(){if(!s.device||s.device.status!=="online"){c.value="设备不在线";return}if(t){c.value=t;return}_.value=!1,c.value=null;try{let o=e;if(!o&&!q.value){c.value=`启动串流失败 (${s.device.deviceId}): 未提供有效端口。`;return}if(!o&&q.value)return;if(!(yield J())){o&&(yield x(!1,!0));return}const d=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws/wsscrcpy?udid=${s.device.deviceId}&port=${o}`;if(a.value)try{a.value.isClosed=!0,a.value.onmessage=null,a.value.onerror=null,a.value.onclose=null,a.value.close()}catch(h){console.warn(`关闭旧WebSocket连接出错 (从设备 ${s.device.deviceId}):`,h)}const i=new WebSocket(d);i.isClosed=!1,i.deviceId=s.device.deviceId,a.value=i,i.binaryType="arraybuffer";const T=setTimeout(()=>{!k.value||i.isClosed||i.readyState!==WebSocket.OPEN&&(c.value="WebSocket连接超时",i.isClosed=!0,i.close(),x(!1,!0))},15e3);i.onopen=()=>w(null,null,function*(){if(!k.value||i.isClosed)return;if(clearTimeout(T),yield ee(),!(yield J())){console.error(`[SlaveDevicePlayer ${s.device.deviceId}] Player initialization failed after WebSocket connected.`);return}if(n.value&&typeof n.value.play=="function")try{n.value.play()}catch(S){console.error(`[SlaveDevicePlayer ${s.device.deviceId}] Error calling player.play():`,S),c.value=`播放器启动失败: ${S instanceof Error?S.message:"未知错误"}`;return}else{console.warn(`[SlaveDevicePlayer ${s.device.deviceId}] Player instance or play method not available.`),c.value="播放器实例或播放方法无效";return}c.value=null});let M=!1;const L=setTimeout(()=>{!k.value||i.isClosed||M||(c.value="未收到视频数据",x(!1,!0))},1e4);i.onmessage=h=>{i.isClosed||!k.value||(M||(M=!0,clearTimeout(L)),Ae(h,i))},i.onerror=h=>{!k.value||i.isClosed||(clearTimeout(T),clearTimeout(L),console.error(`从设备 ${s.device.deviceId} WebSocket Error:`,h),c.value="WebSocket连接错误",x(!1,!0))},i.onclose=h=>w(null,null,function*(){if(!k.value||i.isClosed)return;clearTimeout(T),clearTimeout(L),i.isClosed=!0;const S=`WebSocket连接已关闭 (code: ${h.code}, reason: ${h.reason||"无"})`;if(c.value=S,_.value=!1,n.value)try{n.value.stop()}catch(z){console.warn(`[SlaveDevicePlayer ${s.device.deviceId}] Error stopping player in onclose:`,z)}yield ee()})}catch(o){console.error(`从设备 ${s.device.deviceId} 启动流过程中发生代码错误:`,o),c.value=o instanceof Error?o.message:"启动流时发生未知代码错误"}finally{q.value=!1}}),q=p(!1),x=(e=!1,t=!1)=>w(null,null,function*(){var l,r,d;if(_.value=!1,a.value){a.value.isClosed=!0;try{a.value.onmessage=null,a.value.onerror=null,(!t||e)&&(a.value.onclose=null),a.value.close()}catch(i){console.warn(`关闭WebSocket连接出错 (从设备 ${s.device.deviceId}，内部调用):`,i)}a.value=null}if(n.value){try{n.value.stop()}catch(i){console.warn(`停止播放器出错 (从设备 ${s.device.deviceId}，内部调用):`,i)}n.value=null}if(((l=s.device)==null?void 0:l.deviceId)&&(e||!t))try{const i=yield lt([s.device.deviceId]),T=(d=(r=i.data)==null?void 0:r.results)==null?void 0:d[s.device.deviceId];i.code===0&&T||console.warn(`停止从设备 ${s.device.deviceId} 串流后端可能失败:`,i.message||"未知错误")}catch(i){console.error("调用批量停止串流API失败 (从设备):",i)}e?c.value=null:t&&c.value||t||(c.value=null)}),De=()=>w(null,null,function*(){yield x(!0)}),ne=()=>w(null,null,function*(){if(c.value=null,_.value=!1,yield ee(),n.value&&n.value.stop(),!(yield J())){console.error(`[SlaveDevicePlayer ${s.device.deviceId}] Player re-initialization failed during retry.`);return}if(a.value&&a.value.readyState===WebSocket.OPEN)ae();else{a.value&&(a.value.onclose=null,a.value.close(),a.value=null);try{const t=yield st([s.device.deviceId]);if(t.code===0&&t.data&&t.data.results){const o=t.data.results[s.device.deviceId];o&&o.success&&o.port?yield se(o.port):c.value=(o==null?void 0:o.error)||"重试获取端口失败"}else c.value=`重试API失败: ${t.message||"未知错误"}`}catch(t){console.error(`[SlaveDevicePlayer ${s.device.deviceId}] Error during retry API call:`,t),c.value=`重试请求错误: ${t instanceof Error?t.message:"未知客户端错误"}`}}}),ie=()=>Ze(m.value),B=(e,t,o=0,l=0)=>{if(!a.value||a.value.readyState!==WebSocket.OPEN){console.warn("WebSocket连接不可用，无法发送按键事件");return}je(a.value,e,t,o,l)},we=e=>{if(!D.value)return;e.preventDefault(),e.code==="ShiftLeft"||e.code==="ShiftRight"?m.value.shift=!0:e.code==="ControlLeft"||e.code==="ControlRight"?m.value.ctrl=!0:e.code==="AltLeft"||e.code==="AltRight"?m.value.alt=!0:e.code==="MetaLeft"||e.code==="MetaRight"?m.value.meta=!0:e.code==="CapsLock"&&(m.value.capsLock=!m.value.capsLock);const t=pe(e.code);t&&B(ye.DOWN,t,e.repeat?1:0,ie())},Ne=e=>{if(!D.value)return;e.preventDefault(),e.code==="ShiftLeft"||e.code==="ShiftRight"?m.value.shift=!1:e.code==="ControlLeft"||e.code==="ControlRight"?m.value.ctrl=!1:e.code==="AltLeft"||e.code==="AltRight"?m.value.alt=!1:(e.code==="MetaLeft"||e.code==="MetaRight")&&(m.value.meta=!1);const t=pe(e.code);t&&B(ye.UP,t,0,ie())},re=e=>{if(!a.value||a.value.readyState!==WebSocket.OPEN||!e){console.warn("WebSocket连接不可用或文本为空，无法发送文本输入事件");return}const t=String(e);Je(a.value,t)},Pe=(e,t,o=0,l=0)=>{!a.value||a.value.readyState!==WebSocket.OPEN||B(e,t,o,l)},be=e=>{!a.value||a.value.readyState!==WebSocket.OPEN||re(e)};He(()=>{k.value=!0,document.addEventListener("click",ce)});const ce=e=>{if(!D.value)return;const t=document.querySelector(`.device-card[data-device-id="${s.device.deviceId}"]`);t&&!t.contains(e.target)&&(D.value=!1)};return xe(()=>{document.removeEventListener("click",ce)}),G({startStream:se,stopStream:De,retryStream:ne,sendTouchEvent:O,sendNavigation:K,getConnectionStatus:()=>a.value&&a.value.readyState===WebSocket.OPEN,sendKeyEvent:B,sendText:re,receiveSyncedKeyEvent:Pe,receiveSyncedTextEvent:be,activateKeyboard:()=>{D.value=!0},deactivateKeyboard:()=>{D.value=!1},isKeyboardEnabled:()=>D.value,isExpanded:()=>I.value,expand:()=>{I.value||j()},collapse:()=>{I.value&&j()},showError:e=>{c.value=e}}),(e,t)=>{const o=V("el-tooltip"),l=V("el-icon"),r=V("el-button"),d=V("el-dropdown-item"),i=V("el-dropdown-menu"),T=V("el-dropdown");return E(),W("div",{class:Ve(["device-card other-device",{"expanded-mode":I.value}]),tabindex:"0","data-device-id":C.device.deviceId,onKeydown:we,onKeyup:Ne},[y("div",it,[y("div",rt,[u(o,{content:C.device.name,placement:"top",enterable:!0,"hide-after":1e3,"popper-class":"copyable-tooltip"},{default:v(()=>[y("span",ct,Z(C.device.name),1)]),_:1},8,["content"])]),y("div",null,[u(r,{link:"",class:"expand-button",onClick:ue(j,["stop"])},{default:v(()=>[I.value?(E(),de(l,{key:1},{default:v(()=>[u(N(Le))]),_:1})):(E(),de(l,{key:0},{default:v(()=>[u(N(Ye))]),_:1}))]),_:1})])]),y("div",dt,[C.device.status==="online"?(E(),W(ze,{key:0},[!c.value&&_.value?(E(),W("div",{key:0,class:"touch-layer",onMousedown:me,onMousemove:he,onMouseup:oe,onMouseleave:oe,onTouchstart:Ce,onTouchmove:Ie,onTouchend:ge},null,32)):X("",!0),c.value?X("",!0):(E(),W("div",{key:1,class:"other-device-player-container",id:`player-container-${C.device.deviceId}`,ref_key:"playerContainer",ref:b},[_.value?X("",!0):(E(),W("div",vt,[u(l,{class:"loading-icon"},{default:v(()=>[u(N(Ke))]),_:1}),t[2]||(t[2]=y("span",null,"视频加载中...",-1))]))],8,ut)),c.value?(E(),W("div",ft,[y("div",pt,[u(l,null,{default:v(()=>[u(N(ve))]),_:1}),y("span",yt,Z(c.value),1)]),u(r,{size:"small",type:"primary",onClick:ue(ne,["stop"]),class:"retry-button"},{default:v(()=>t[3]||(t[3]=[$(" 重试 ")])),_:1})])):X("",!0)],64)):(E(),W("div",St,[y("div",mt,[u(l,null,{default:v(()=>[u(N(ve))]),_:1}),t[4]||(t[4]=y("span",null,"设备离线",-1))])]))]),y("div",ht,[u(o,{content:"ID: "+C.device.deviceId,placement:"top",enterable:!0,"hide-after":1e3,"popper-class":"copyable-tooltip"},{default:v(()=>[y("div",Ct,Z(C.device.deviceId),1)]),_:1},8,["content"]),y("div",It,[u(T,{trigger:"click"},{dropdown:v(()=>[u(i,null,{default:v(()=>[u(d,{onClick:_e},{default:v(()=>t[6]||(t[6]=[$("主页")])),_:1}),u(d,{onClick:Te},{default:v(()=>t[7]||(t[7]=[$("返回")])),_:1}),u(d,{onClick:Ee},{default:v(()=>t[8]||(t[8]=[$("任务管理")])),_:1}),u(d,{divided:""}),u(d,{onClick:t[0]||(t[0]=M=>le("setAsMain"))},{default:v(()=>t[9]||(t[9]=[$("设为主设备")])),_:1}),u(d,{onClick:t[1]||(t[1]=M=>le("removeDevice"))},{default:v(()=>t[10]||(t[10]=[$("移除设备")])),_:1})]),_:1})]),default:v(()=>[u(r,{plain:"",size:"small"},{default:v(()=>[t[5]||(t[5]=$(" 操作 ")),u(l,{class:"el-icon--right"},{default:v(()=>[u(N(Be))]),_:1})]),_:1})]),_:1})])])],42,nt)}}}),Nt=Ue(gt,[["__scopeId","data-v-f36dbaa3"]]);export{Nt as default};
