var x=(H,K,b)=>new Promise((s,c)=>{var f=a=>{try{y(b.next(a))}catch(h){c(h)}},m=a=>{try{y(b.throw(a))}catch(h){c(h)}},y=a=>a.done?s(a.value):Promise.resolve(a.value).then(f,m);y((b=b.apply(H,K)).next())});import{_ as Ue,r as u,o as Ye,C as Be,p as se,q as ne,G as le,E as He,F as Ke,P as ce,Q as Re,bq as Xe,k as Y,V as Ae}from"./index-DqYxAufE.js";import{m as Ve,n as _e}from"./device-MWnAPMey.js";import{b as ie,h as ze,c as ue,d as Fe,e as qe,f as Je,s as je,g as Ge,a as Qe,m as _,K as B,i as Ze,j as et,T as w,k as tt,W as de,M as ve}from"./KeyboardMapping-D5a5ZElr.js";const ot={__name:"DeviceStream",props:{deviceId:{type:String,required:!0},autoConnect:{type:Boolean,default:!0},serverUrl:{type:String,default:"/scrcpy"},decoderType:{type:String,default:"webcodecs"}},emits:["success","stream-error","loading-start","orientation-change"],setup(H,{expose:K,emit:b}){const s=H,c=b,f=u(null),m=u(null),y=u(""),a=u(null),h=u(!1),I=u(!1),l=u(null),T=u(0),M=u(0),W=u({x:0,y:0}),z=u({x:0,y:0}),S=u(!1),d=u(!1),C=u({shift:!1,ctrl:!1,alt:!1,meta:!1,capsLock:!1}),p=u({isComposing:!1,compositionText:"",lastCompositionText:""}),F=(e,t)=>{let o=0;return function(...r){const n=new Date().getTime();if(!(n-o<t))return o=n,e.apply(this,r)}},fe=(e,t)=>{let o=null;return function(...r){o&&clearTimeout(o),o=setTimeout(()=>{e.apply(this,r)},t)}};let q=0,J=0;const R=(e,t)=>{if(e&&t&&e>0&&t>0&&(q!==e||J!==t)){q=e,J=t,T.value=e,M.value=t;const o=e>t;h.value!==o&&(h.value=o),c("orientation-change",{deviceId:s.deviceId,orientation:h.value?"landscape":"portrait",rotation:h.value?90:0,width:e,height:t,actualWidth:e,actualHeight:t}),j()}},pe=fe((e,t)=>{R(e,t)},50),j=()=>{if(!f.value||!f.value.parentElement)return;const e=f.value.parentElement;T.value>0&&M.value>0&&(e.style.width=`${T.value}px`,e.style.height=`${M.value}px`)},me=()=>{if(l.value&&l.value.videoWidth&&l.value.videoHeight){const e=l.value.videoWidth,t=l.value.videoHeight;if(e>0&&t>0)return{width:e,height:t}}return null},ye=(e,t)=>{var P;if(T.value<=0||M.value<=0)return{x:e,y:t};const o=(P=f.value)==null?void 0:P.parentElement;if(!o)return{x:e,y:t};const r=o.getBoundingClientRect(),n=T.value/r.width,i=M.value/r.height,g=Math.round(e*n),O=Math.round(t*i);return{x:g,y:O}},E=(e,t,o)=>{if(!a.value||a.value.readyState!==WebSocket.OPEN){console.warn("WebSocket连接不可用，无法发送触摸事件");return}if(e===w.DOWN&&T.value<=0||M.value<=0){const i=me();i&&i.width>0&&i.height>0&&pe(i.width,i.height)}const{x:r,y:n}=ye(t,o);tt(a.value,e,r,n)},$=()=>et(C.value),N=(e,t,o=0,r=0)=>{if(!a.value||a.value.readyState!==WebSocket.OPEN){console.warn("WebSocket连接不可用，无法发送按键事件");return}ie(a.value,e,t,o,r)},X=e=>{if(!a.value||a.value.readyState!==WebSocket.OPEN||!e){console.warn("WebSocket连接不可用或文本为空，无法发送文本输入事件");return}const t=String(e);if(/[\u4e00-\u9fa5]/.test(t)){A(t,!0);return}Qe(a.value,t)},he=()=>!a.value||a.value.readyState!==WebSocket.OPEN?(console.warn("WebSocket连接不可用，无法获取设备剪贴板"),Promise.reject(new Error("WebSocket连接不可用"))):new Promise((e,t)=>{const o=r=>{try{if(a.value.removeEventListener("message",o),typeof r.data=="string")try{const n=JSON.parse(r.data);if(n.type==="deviceMessage"&&n.messageType==="clipboard"){a.value.removeEventListener("message",o),e(n.text||"");return}}catch(n){console.warn("WebSocket消息不是有效的JSON:",n)}else if(r.data instanceof ArrayBuffer){const n=new Uint8Array(r.data);if(new TextDecoder("utf-8").decode(n.slice(0,14))==="scrcpy_message"){const g=ue(n,n[14]);if(g&&g.messageType==="clipboard"){e(g.text||"");return}}}a.value.addEventListener("message",o)}catch(n){t(n)}};a.value.addEventListener("message",o),Ge(a.value),setTimeout(()=>{a.value.removeEventListener("message",o),t(new Error("获取剪贴板超时"))},5e3)}),A=(e,t=!1)=>{if(!a.value||a.value.readyState!==WebSocket.OPEN){console.warn("WebSocket连接不可用，无法设置设备剪贴板");return}je(a.value,e,t)},ge=(e,t=0)=>{if(!a.value||a.value.readyState!==WebSocket.OPEN){console.warn("WebSocket连接不可用，无法发送组合键");return}Je(a.value,e,t)},Se=e=>{S.value=!0,z.value={x:e.offsetX,y:e.offsetY},W.value={x:e.offsetX,y:e.offsetY},E(w.DOWN,e.offsetX,e.offsetY)},Ce=e=>{const t=f.value.getBoundingClientRect();e.clientX>=t.left&&e.clientX<=t.right&&e.clientY>=t.top&&e.clientY<=t.bottom?d.value||(d.value=!0,m.value&&m.value.focus()):d.value&&(d.value=!1,m.value&&m.value.blur()),Se(e)},G=F(e=>{S.value&&(W.value={x:e.offsetX,y:e.offsetY},E(w.MOVE,e.offsetX,e.offsetY))},16),Q=e=>{S.value&&(S.value=!1,E(w.UP,e.offsetX,e.offsetY))},ke=e=>{if(e.preventDefault(),e.touches.length===0)return;const t=e.touches[0],o=e.currentTarget.getBoundingClientRect(),r=t.clientX-o.left,n=t.clientY-o.top;S.value=!0,z.value={x:r,y:n},W.value={x:r,y:n},E(w.DOWN,r,n)},Z=F(e=>{if(e.preventDefault(),!S.value||e.touches.length===0)return;const t=e.touches[0],o=e.currentTarget.getBoundingClientRect(),r=t.clientX-o.left,n=t.clientY-o.top;W.value={x:r,y:n},E(w.MOVE,r,n)},16),we=e=>{if(e.preventDefault(),!S.value)return;S.value=!1;const t=W.value.x,o=W.value.y;E(w.UP,t,o)},ee=()=>x(null,null,function*(){var e;if(s.deviceId){c("loading-start",s.deviceId);try{const t=yield Ve(s.deviceId);if(t.code!==0){c("stream-error",{deviceId:s.deviceId,error:"启动设备串流失败: "+(t.message||"未知错误")});return}if(I.value=!0,yield Ae(),!f.value){c("stream-error",{deviceId:s.deviceId,error:"无法初始化播放器容器"});return}try{yield Le();const o=(e=t.data)==null?void 0:e.port;if(!o){c("stream-error",{deviceId:s.deviceId,error:"无效的端口信息"});return}const n=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws/wsscrcpy?udid=${s.deviceId}&port=${o}`;if(a.value)try{a.value.isClosed=!0,a.value.onmessage=null,a.value.onerror=null,a.value.onclose=null,a.value.close()}catch(v){console.warn("关闭旧WebSocket连接出错:",v)}const i=new WebSocket(n);i.isClosed=!1,a.value=i,i.binaryType="arraybuffer";const g=setTimeout(()=>{i.readyState!==WebSocket.OPEN&&(console.error("WebSocket连接超时"),c("stream-error",{deviceId:s.deviceId,error:"WebSocket连接超时"}),i.isClosed=!0,i.close())},15e3);i.onopen=()=>x(null,null,function*(){if(!i.isClosed){if(clearTimeout(g),l.value&&typeof l.value.play=="function")try{l.value.play()}catch(v){console.error(`[DeviceStream ${s.deviceId}] Error calling player.play():`,v),c("stream-error",{deviceId:s.deviceId,error:`播放器启动失败: ${v instanceof Error?v.message:"未知错误"}`});return}else{console.warn(`[DeviceStream ${s.deviceId}] Player instance or play method not available.`),c("stream-error",{deviceId:s.deviceId,error:"播放器实例或播放方法无效"});return}setTimeout(()=>{c("success",s.deviceId,{initialConnect:!0})},200)}});let O=!1;const P=setTimeout(()=>{O||(console.warn("WebSocket连接成功但10秒内没有收到数据"),c("stream-error",{deviceId:s.deviceId,error:"未收到视频数据，请检查设备串流状态"}))},1e4);let ae=0;i.onmessage=v=>{if(!i.isClosed)if(O||(O=!0,clearTimeout(P)),v.data instanceof ArrayBuffer){if(!ze(v.data,{onInitialMessage:U=>{Fe(i)&&c("success",s.deviceId,{initialConnect:!1,videoReceived:!0})},onDeviceMessage:(U,k)=>{const re=ue(U,k);re&&te(re)}})){const U=new Uint8Array(v.data);try{if(l.value){l.value.pushFrame(U);const k=Date.now();k-ae>100&&(ae=k,l.value.videoWidth&&l.value.videoHeight&&(R(l.value.videoWidth,l.value.videoHeight),c("success",s.deviceId,{initialConnect:!1,videoReceived:!0})))}}catch(k){console.error("处理视频帧出错:",k)}}}else try{const L=JSON.parse(v.data);te(L)}catch(L){console.warn("解析控制消息失败:",L)}},i.onerror=v=>{console.error("WebSocket错误:",v),clearTimeout(g),clearTimeout(P),c("stream-error",{deviceId:s.deviceId,error:"WebSocket连接错误"})},i.onclose=()=>{clearTimeout(g),clearTimeout(P),i.isClosed||c("stream-error",{deviceId:s.deviceId,error:"WebSocket连接已关闭"})}}catch(o){console.error("初始化解码器出错:",o),c("stream-error",{deviceId:s.deviceId,error:"初始化解码器失败: "+(o.message||"未知错误")})}}catch(t){console.error("调用设备串流API失败:",t),c("stream-error",{deviceId:s.deviceId,error:"调用设备串流API失败: "+(t.message||"未知错误")})}}}),te=e=>{!e||!e.type||Ze(e,{onVideoSize:(t,o)=>{R(t,o)},onConnected:t=>{},onDisconnected:(t,o)=>{console.warn("设备连接已断开:",t),c("stream-error",{deviceId:s.deviceId,error:"设备连接已断开: "+t})},onError:(t,o)=>{console.error("设备错误:",t),c("stream-error",{deviceId:s.deviceId,error:"设备错误: "+t})},onClipboard:t=>{const o=new CustomEvent("device-clipboard",{detail:{text:t}});document.dispatchEvent(o)}})},be=()=>x(null,null,function*(){I.value&&(yield V()),setTimeout(()=>{ee()},500)}),V=()=>x(null,null,function*(){if(I.value&&s.deviceId)try{yield _e(s.deviceId),I.value=!1}catch(e){console.error("停止设备串流失败:",e),I.value=!1}if(a.value)try{a.value.isClosed=!0,a.value.onmessage=null,a.value.onerror=null,a.value.onclose=null,a.value.close(),a.value=null}catch(e){console.warn("关闭WebSocket连接出错:",e)}if(l.value)try{l.value.stop(),l.value=null}catch(e){console.warn("停止播放器出错:",e)}return!0}),Ie=u(""),Te=u(""),Me=u(!1);Ye(()=>{s.autoConnect&&s.deviceId&&ee(),document.addEventListener("click",e=>{if(!d.value)return;const t=document.querySelector(".device-stream-container");t&&!t.contains(e.target)&&(d.value=!1)})}),Be(()=>{D&&(clearInterval(D),D=null),V().catch(e=>{console.error("组件卸载时停止设备串流失败:",e)})}),K({retryConnect:be,closeConnection:V,updateContainerSize:j,sendText:X,sendKeyEvent:N,sendKeyCodeEvent:ie,getDeviceClipboard:he,setClipboard:A,sendCombinationKey:ge,sendNavigationCommand:e=>!a.value||a.value.readyState!==WebSocket.OPEN?(console.warn(`WebSocket连接不可用，无法发送${e}命令`),!1):e==="home"||e==="back"||e==="overview"||e==="power"?(qe(a.value,e),!0):(console.warn(`不支持的导航命令类型: ${e}`),!1),isKeyboardEnabled:()=>d.value,getWebSocketConnection:()=>a.value});const We=e=>{const t=e.target.value;if(!p.value.isComposing){if(t){const o=y.value||"";let r="";if(t.length>o.length)r=t.slice(o.length);else if(t.length<o.length){const n=_("Backspace");n&&(N(B.DOWN,n,0,$()),N(B.UP,n,0,$()))}else r=t;r&&X(r)}setTimeout(()=>{p.value.isComposing||(y.value="")},0)}},Ee=e=>{if(d.value&&!p.value.isComposing){if(e.key==="Backspace"||e.key==="Delete"||e.key==="Enter"||e.key==="Tab"||e.key==="Escape"||e.key.startsWith("Arrow")||e.key==="Home"||e.key==="End"||e.key==="PageUp"||e.key==="PageDown"){const t=_(e.code);t&&N(B.DOWN,t,e.repeat?1:0,$()),e.preventDefault();return}oe(e,!0)}},De=e=>{if(d.value&&!p.value.isComposing){if(e.key==="Backspace"||e.key==="Delete"||e.key==="Enter"||e.key==="Tab"||e.key==="Escape"||e.key.startsWith("Arrow")||e.key==="Home"||e.key==="End"||e.key==="PageUp"||e.key==="PageDown"){const t=_(e.code);t&&N(B.UP,t,0,$()),e.preventDefault();return}oe(e,!1)}},Pe=()=>{d.value&&setTimeout(()=>{m.value&&d.value&&m.value.focus()},0)},oe=(e,t)=>{e.code==="ShiftLeft"||e.code==="ShiftRight"?C.value.shift=t:e.code==="ControlLeft"||e.code==="ControlRight"?C.value.ctrl=t:e.code==="AltLeft"||e.code==="AltRight"?C.value.alt=t:e.code==="MetaLeft"||e.code==="MetaRight"?C.value.meta=t:e.code==="CapsLock"&&t&&(C.value.capsLock=!C.value.capsLock)},xe=e=>{d.value&&(p.value.isComposing=!0,p.value.compositionText="",p.value.lastCompositionText="")},Ne=e=>{d.value&&(p.value.compositionText=e.data||"")},Oe=e=>{if(!d.value)return;const t=e.data||"";p.value.isComposing=!1,p.value.compositionText="",p.value.lastCompositionText="",setTimeout(()=>{y.value=""},0),t&&t.trim()&&(/[^\x00-\x7F]/.test(t)?A(t,!0):X(t))};let D=null;const $e=()=>{if(!(!l.value||!I.value)&&l.value.constructor.name==="MsePlayer"){const e=l.value;if(typeof e.forceReset=="function"){const t=Date.now();if(e.seekingSince&&e.seekingSince!==-1){const o=t-e.seekingSince;o>1e4&&(console.warn(`[DeviceStream] MSE播放器seek状态过长 (${o}ms)，执行强制重置`),e.forceReset())}}}},Le=(e=null)=>x(null,null,function*(){l.value&&(l.value.stop(),l.value=null);const t=e||s.decoderType;let o,r="";if(t==="webcodecs"&&window.VideoDecoder)o=de,r="WebCodecs";else if(t==="mse"&&window.MediaSource)o=ve,r="MsePlayer";else if(window.VideoDecoder&&t!=="mse")console.warn(`[DeviceStream] ${t} 解码器不可用或未指定，回退到 WebCodecs`),o=de,r="WebCodecs (Fallback)";else if(window.MediaSource)console.warn(`[DeviceStream] ${t} 解码器不可用或 WebCodecs 失败，回退到 MsePlayer`),o=ve,r="MsePlayer (Fallback)",localStorage.setItem("cloudphone_decoderType","mse");else return console.error("[DeviceStream] 没有可用的解码器 (WebCodecs, MsePlayer)"),c("stream-error",{deviceId:s.deviceId,error:"没有可用的解码器"}),null;if(!o)return console.error(`[DeviceStream] 无法确定播放器类，选择的解码器: ${t}`),c("stream-error",{deviceId:s.deviceId,error:`无法加载解码器: ${t}`}),null;if(l.value=new o,f.value&&l.value)l.value.setParent(f.value),typeof l.value.play=="function"?l.value.play():console.warn(`[DeviceStream] 播放器 ${r} 没有 play 方法`),r.includes("MsePlayer")&&(D&&clearInterval(D),D=setInterval($e,5e3));else return console.error("[DeviceStream]播放器容器或播放器实例不存在"),c("stream-error",{deviceId:s.deviceId,error:"播放器容器初始化失败"}),null;return l.value});return(e,t)=>(ne(),se("div",{class:ce(["device-stream-container",{landscape:h.value}]),onMousedown:Ce,onMousemove:t[1]||(t[1]=(...o)=>Y(G)&&Y(G)(...o)),onMouseup:Q,onMouseleave:Q,onTouchstart:ke,onTouchmove:t[2]||(t[2]=(...o)=>Y(Z)&&Y(Z)(...o)),onTouchend:we},[le("div",{ref_key:"playerContainer",ref:f,class:"player-container"},null,512),Me.value?(ne(),se("div",{key:0,class:ce(["keyboard-status",Te.value])},Re(Ie.value),3)):He("",!0),Ke(le("input",{ref_key:"hiddenInput",ref:m,"onUpdate:modelValue":t[0]||(t[0]=o=>y.value=o),class:"hidden-input",type:"text",onCompositionstart:xe,onCompositionupdate:Ne,onCompositionend:Oe,onInput:We,onKeydown:Ee,onKeyup:De,onBlur:Pe},null,544),[[Xe,y.value]])],34))}},ut=Ue(ot,[["__scopeId","data-v-541caabc"]]);export{ut as default};
