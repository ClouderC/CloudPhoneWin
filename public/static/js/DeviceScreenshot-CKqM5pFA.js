var k=(H,L,y)=>new Promise((e,o)=>{var l=c=>{try{i(y.next(c))}catch(f){o(f)}},s=c=>{try{i(y.throw(c))}catch(f){o(f)}},i=c=>c.done?e(c.value):Promise.resolve(c.value).then(l,s);i((y=y.apply(H,L)).next())});import{l as j}from"./device-MWnAPMey.js";import{v as G,r as v,A as V,o as Q,C as W,p as b,q as _,P as F,E as x,G as u,H as Z,Q as J,D as K,R as E,S as q,t as X,_ as Y}from"./index-DqYxAufE.js";const ee={key:0,class:"screenshot-error"},ae={class:"error-content"},te={class:"error-text"},re={key:1,class:"screenshot-disconnected"},se={class:"disconnected-content"},le={class:"images-container"},oe=["src"],ne={key:2,class:"screenshot-placeholder"},ie=G({__name:"DeviceScreenshot",props:{deviceId:{type:String,required:!0},autoCapture:{type:Boolean,default:!0},quality:{type:Number,default:90},refreshInterval:{type:Number,default:1e4},autoRefresh:{type:Boolean,default:!0},isLandscape:{type:Boolean,default:!1},useBinaryApi:{type:Boolean,default:!0},scale:{type:Number,default:.5},format:{type:String,default:"webp"}},emits:["screenshot-ready","screenshot-error","click"],setup(H,{expose:L,emit:y}){const e=H,o=y,l=v(!1),s=v(""),i=v(!1),c=v(null);v(Date.now());const f=v(null),m=v(null),p=v(!1),n=v(!1),d=v(!document.hidden),S=v(null);let w=null;const A=r=>{if(!e.deviceId)return null;const t=`/api/screenshot/binary/${e.deviceId}`,a=new URLSearchParams;return a.append("quality",e.quality.toString()),a.append("scale",e.scale.toString()),a.append("format",e.format),e.isLandscape&&a.append("rotate","true"),a.append("v",r.toString()),`${t}?${a.toString()}`},h=()=>k(null,null,function*(){if(!(!n.value||!d.value||!e.deviceId||p.value))try{l.value=!1,i.value=!1,p.value=!0;const r=Date.now(),t=A(r);if(!t){p.value=!1;return}if(f.value?f.value.src=t:(m.value=t,p.value=!1),!e.useBinaryApi){const a=yield j({deviceId:e.deviceId,quality:e.quality,scale:e.scale,format:e.format});if(!a.data){console.error("截图响应缺少data字段:",a),l.value=!0,s.value="响应格式错误",o("screenshot-error",s.value);return}if(a.code===0){let R=!1,I="",D="";if("success"in a.data&&(R=a.data.success),"imageData"in a.data&&a.data.imageData&&(I=a.data.imageData),"error"in a.data&&a.data.error&&(D=a.data.error),R&&I){i.value=!1;let N=I.startsWith("data:image")?I:`data:image/jpeg;base64,${I.replace(/^[\s\r\n]+|[\s\r\n]+$/g,"")}`;m.value=N,o("screenshot-ready",N)}else l.value=!0,s.value=D||"获取截图失败",o("screenshot-error",s.value)}else l.value=!0,s.value=a.message||"截图请求失败",o("screenshot-error",s.value);p.value=!1}}catch(r){l.value=!0,s.value="获取截图请求失败",o("screenshot-error",s.value),console.error("截图请求失败:",r),p.value=!1}}),P=()=>{f.value&&f.value.src&&(m.value=f.value.src,o("screenshot-ready",m.value)),p.value=!1},U=()=>{console.error("预加载图片失败"),p.value=!1,m.value||(l.value=!0,s.value="截图失败",o("screenshot-error",s.value))},$=()=>{l.value=!1},B=()=>k(null,null,function*(){try{yield h()}catch(r){i.value=!0,console.error("设备连接检查失败:",r),o("screenshot-error","设备连接已断开")}}),C=()=>{!e.autoRefresh||e.refreshInterval<=0||!n.value||!d.value||(g(),c.value=window.setInterval(()=>{e.deviceId&&n.value&&d.value&&h()},e.refreshInterval))},g=()=>{c.value!==null&&(window.clearInterval(c.value),c.value=null)},z=()=>{o("click")},O=r=>{console.error("图片加载失败:",r),l.value=!0,s.value="截图数据无效或已过期",o("screenshot-error",s.value)},T=()=>{if(!window.IntersectionObserver){n.value=!0;return}w=new IntersectionObserver(r=>{const a=r[0].isIntersecting;n.value!==a&&(n.value=a,a?(e.autoCapture&&e.deviceId&&d.value&&h(),e.autoRefresh&&d.value&&C()):g())},{threshold:.1}),S.value&&w.observe(S.value)},M=()=>{d.value=!document.hidden,d.value?(n.value&&e.autoCapture&&e.deviceId&&h(),n.value&&e.autoRefresh&&C()):g()};return V(()=>e.deviceId,r=>{r&&e.autoCapture&&n.value&&d.value?(h(),e.autoRefresh&&C()):g()}),V(()=>e.autoRefresh,r=>{r&&n.value&&d.value?C():g()}),V(()=>e.refreshInterval,()=>{e.autoRefresh&&n.value&&d.value&&C()}),V(()=>e.useBinaryApi,()=>{e.deviceId&&e.autoCapture&&n.value&&d.value&&h()}),Q(()=>{T(),document.addEventListener("visibilitychange",M)}),W(()=>{g(),w&&(w.disconnect(),w=null),document.removeEventListener("visibilitychange",M)}),L({captureScreenshot:h,startAutoRefresh:C,stopAutoRefresh:g,checkConnection:B}),(r,t)=>{const a=K("el-button");return _(),b("div",{class:F(["device-screenshot-container",{error:l.value,disconnected:i.value}]),ref_key:"containerRef",ref:S},[l.value&&!i.value?(_(),b("div",ee,[u("div",ae,[t[1]||(t[1]=u("div",{class:"error-icon"},[u("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[u("path",{d:"M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z",fill:"currentColor"})])],-1)),u("div",te,J(s.value),1),Z(a,{size:"small",type:"primary",onClick:h,class:"retry-button"},{default:E(()=>t[0]||(t[0]=[q(" 重试 ")])),_:1})])])):x("",!0),i.value?(_(),b("div",re,[u("div",se,[t[3]||(t[3]=u("div",{class:"disconnected-icon"},[u("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[u("path",{d:"M1 21H23L12 2L1 21ZM13 18H11V16H13V18ZM13 14H11V10H13V14Z",fill:"currentColor"})])],-1)),t[4]||(t[4]=u("div",{class:"disconnected-text"},"连接已断开",-1)),Z(a,{size:"small",type:"primary",onClick:B,class:"retry-button"},{default:E(()=>t[2]||(t[2]=[q(" 重试连接 ")])),_:1})])])):x("",!0),u("div",le,[!l.value&&!i.value&&n.value?(_(),b("img",{key:0,src:m.value,class:"screenshot-image",alt:"设备截图",onClick:z,onError:O,onLoad:$},null,40,oe)):x("",!0),u("img",{ref_key:"preloadImg",ref:f,class:"preload-image",onLoad:P,onError:U},null,544)]),!m.value&&!l.value&&!i.value?(_(),b("div",ne,t[5]||(t[5]=[X('<div class="placeholder-content" data-v-5858a331><div class="placeholder-icon" data-v-5858a331><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-5858a331><path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM19 19H5V5H19V19Z" fill="currentColor" data-v-5858a331></path><path d="M13.96 12.17L11.06 14.47L9.23 12.28C8.95 11.95 8.45 11.95 8.17 12.28L5.5 15.34C5.17 15.72 5.44 16.25 5.91 16.25H18.09C18.56 16.25 18.83 15.72 18.5 15.34L15.83 12.17C15.54 11.84 15.04 11.84 14.75 12.17H13.96Z" fill="currentColor" data-v-5858a331></path><circle cx="9.5" cy="9.5" r="1.5" fill="currentColor" data-v-5858a331></circle></svg></div><div class="placeholder-text" data-v-5858a331>暂无截图</div><div class="placeholder-subtitle" data-v-5858a331>等待设备响应中...</div></div>',1)]))):x("",!0)],2)}}}),ve=Y(ie,[["__scopeId","data-v-5858a331"]]);export{ve as default};
