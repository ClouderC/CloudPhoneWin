var F=(v,g,l)=>new Promise((o,c)=>{var w=r=>{try{s(l.next(r))}catch(n){c(n)}},b=r=>{try{s(l.throw(r))}catch(n){c(n)}},s=r=>r.done?o(r.value):Promise.resolve(r.value).then(w,b);s((l=l.apply(v,g)).next())});import{a8 as i,v as G,c as K,r as p,p as C,q as V,K as E,H as u,D as m,R as f,E as S,G as d,k as O,aE as A,S as k,U as H,Q as B,_ as Q}from"./index-DqYxAufE.js";import $ from"./TaskProgressDialog-PHmw-w02.js";import{b as J,u as L}from"./file-BLpzX1t2.js";function T(v,g,l=50){return F(this,null,function*(){try{const o=yield J({fileId:v,deviceIds:g,maxWorker:l});if(o.code===0)return i.success("推送任务已创建"),o.data.taskId;throw i.error(o.message||"推送任务创建失败"),new Error(o.message||"推送任务创建失败")}catch(o){throw console.error("推送任务创建出错:",o),i.error("推送任务创建出错"),o}})}const X={class:"file-info"},Y={class:"dialog-footer"},Z=G({__name:"FileUploadDialog",props:{modelValue:{type:Boolean,required:!0},deviceIds:{type:Array,required:!0},maxWorker:{type:Number,default:1}},emits:["update:modelValue","success","error"],setup(v,{emit:g}){const l=v,o=g,c=K({get:()=>l.modelValue,set:e=>o("update:modelValue",e)}),w=p(),b=p({file:null}),s=p([]),r=p(!1),n=p(0),y=p(!1),h=p(""),U=e=>{e&&(s.value=[e])},N=()=>{s.value=[]},M=()=>{c.value=!1,s.value=[],r.value=!1,n.value=0},P=()=>F(null,null,function*(){if(s.value.length===0||!s.value[0].raw){i.warning("请选择要上传的文件");return}r.value=!0,n.value=0;try{const e=setInterval(()=>{n.value<90&&(n.value+=10)},300),a=s.value[0].raw;if(!a)throw new Error("文件对象无效");let _;try{_=yield L(a),clearInterval(e),n.value=100,i.success("文件上传成功"),c.value=!1,s.value=[];let t="";l.deviceIds.length>0&&(t=yield T(_.data.fileId,l.deviceIds,l.maxWorker),h.value=t,y.value=!0),o("success",{fileId:_.data.fileId,taskId:t})}catch(t){if(clearInterval(e),t.code===400&&t.message&&t.message.includes("已存在")){if(l.deviceIds.length>0?i.warning("文件已存在，无需重复上传"):i.warning(t.message),c.value=!1,s.value=[],t.data&&t.data.fileId){let I="";l.deviceIds.length>0&&(I=yield T(t.data.fileId,l.deviceIds,l.maxWorker),h.value=I,y.value=!0),o("success",{fileId:t.data.fileId,taskId:I})}else o("success",{fileId:null,taskId:""});return}throw i.error(t.message||"文件上传失败"),o("error",t),t}}catch(e){console.error("文件推送出错:",e),(!e.message||!e.message.includes("已存在"))&&i.error("文件推送出错"),o("error",e)}finally{r.value=!1}}),R=e=>e<1024?e+"B":e<1024*1024?(e/1024).toFixed(2)+"KB":e<1024*1024*1024?(e/(1024*1024)).toFixed(2)+"MB":(e/(1024*1024*1024)).toFixed(2)+"GB";return(e,a)=>{const _=m("el-icon"),t=m("el-upload"),I=m("el-form-item"),q=m("el-progress"),W=m("el-form"),D=m("el-button"),j=m("el-dialog");return V(),C(E,null,[u(j,{modelValue:c.value,"onUpdate:modelValue":a[0]||(a[0]=x=>c.value=x),title:l.deviceIds.length>0?"文件推送":"文件上传",width:"500px"},{footer:f(()=>[d("span",Y,[u(D,{onClick:M},{default:f(()=>a[6]||(a[6]=[k("取消")])),_:1}),u(D,{type:"primary",loading:r.value,onClick:P},{default:f(()=>[k(B(l.deviceIds.length>0?"上传并推送":"上传文件"),1)]),_:1},8,["loading"])])]),default:f(()=>[u(W,{ref_key:"formRef",ref:w,model:b.value,"label-width":"100px"},{default:f(()=>[u(I,{label:"选择文件"},{default:f(()=>[u(t,{class:"upload-demo",drag:"",action:"#","auto-upload":!1,"on-change":U,"file-list":s.value,"on-remove":N},{default:f(()=>[u(_,{class:"el-icon--upload"},{default:f(()=>[u(O(A))]),_:1}),a[2]||(a[2]=d("div",{class:"el-upload__text"},[k(" 拖拽文件到此处或 "),d("em",null,"点击上传")],-1)),a[3]||(a[3]=d("div",{class:"el-upload__tip"}," 提示：文件大小不能超过 500MB ",-1))]),_:1},8,["file-list"])]),_:1}),s.value.length>0?(V(),C(E,{key:0},[d("div",X,[d("p",null,[a[4]||(a[4]=d("strong",null,"文件名：",-1)),k(B(s.value[0].name),1)]),d("p",null,[a[5]||(a[5]=d("strong",null,"大小：",-1)),k(B(R(s.value[0].size||0)),1)])]),r.value?(V(),H(q,{key:0,percentage:n.value,status:n.value===100?"success":"exception"},null,8,["percentage","status"])):S("",!0)],64)):S("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),u($,{visible:y.value,"onUpdate:visible":a[1]||(a[1]=x=>y.value=x),taskId:h.value,taskType:"file"},null,8,["visible","taskId"])],64)}}}),z=Q(Z,[["__scopeId","data-v-aadc744a"]]),oe=Object.freeze(Object.defineProperty({__proto__:null,default:z},Symbol.toStringTag,{value:"Module"}));export{z as F,oe as a,T as p};
