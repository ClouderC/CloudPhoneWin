var q=(y,F,D)=>new Promise((k,B)=>{var V=d=>{try{m(D.next(d))}catch(g){B(g)}},h=d=>{try{m(D.throw(d))}catch(g){B(g)}},m=d=>d.done?k(d.value):Promise.resolve(d.value).then(V,h);m((D=D.apply(y,F)).next())});import{v as Te,r as i,c as Ee,A as ae,C as Ve,o as ze,p as G,E as P,q as U,G as r,H as l,Q as oe,D as L,R as a,k as b,bj as De,ab as Ie,bk as $e,S as f,P as ne,U as _e,bl as Le,bm as Be,bn as Me,bo as Ne,aX as Re,aM as Oe,bp as We,aC as Pe,O as Ue,aO as Fe,a8 as s,aD as se,_ as He}from"./index-DqYxAufE.js";import Ke from"./DeviceStream-BpxzwTJM.js";import{g as Ae,s as Q,a as Xe}from"./KeyboardMapping-D5a5ZElr.js";import{F as je}from"./FileUploadDialog-D8hAWV6K.js";import"./device-MWnAPMey.js";import"./TaskProgressDialog-PHmw-w02.js";import"./file-BLpzX1t2.js";import"./app-CvfiZxnR.js";const Ye={key:0,class:"stream-dialog-container"},qe={class:"stream-title"},Ge={key:0,class:"stream-loading"},Qe={key:1,class:"stream-error"},Je={class:"error-buttons"},Ze={class:"navigation-bar"},et={class:"dialog-footer"},tt={class:"key-combination-buttons"},lt={class:"dialog-footer"},at=Te({__name:"StreamDialog",props:{modelValue:{type:Boolean,default:!1},deviceId:{type:String,default:""},deviceInfo:{type:Object,default:null},serverUrl:{type:String,default:"/scrcpy"},decoderType:{type:String,default:"webcodecs"}},emits:["update:modelValue","closed"],setup(y,{expose:F,emit:D}){Fe(t=>({"63fbb4b1":S.value+"px","3cbe61c4":w.value+44+"px","66476e5c":w.value+"px"}));const k=y,B=D,V=i(!1),h=i(!1),m=i(!1),d=i(!1),g=i(""),x=i(!1),C=i(null),o=i(null),S=i(0),w=i(0),z=i(!1),I=i(!1),ie=Ee(()=>`${k.deviceId}`),H=i(!1),K=i({x:0,y:0}),c=i(!1),M=i(!1),N=i(""),A=i(!1),p=i(null),X=i(!1),ue=t=>{const n={"1080x2400":{width:432,height:960},"1080x1920":{width:528,height:960},"720x1280":{width:528,height:960}}[t];return n||{width:528,height:960}},O=(t=null)=>{let e;return t?e=ue(t):e={width:528,height:960},{width:e.width,height:e.height,dialogWidth:e.width,dialogHeight:e.height+44}},J=()=>{if(k.deviceInfo&&k.deviceInfo.resolution){const t=O(k.deviceInfo.resolution);return S.value=t.width,w.value=t.height,z.value=!0,!0}return!1},Z=()=>{try{const t=O();S.value=t.width,w.value=t.height,z.value=!0,c.value=!1,I.value=!0,setTimeout(()=>{h.value=!0},100)}catch(t){console.error("使用默认尺寸失败:",t),S.value=528,w.value=960,z.value=!0,c.value=!1,I.value=!0}};ae(()=>k.modelValue,t=>{t?(V.value=!0,m.value=!1,d.value=!1,g.value="",c.value=!0,x.value=!1,J()?(c.value=!1,I.value=!0,setTimeout(()=>{h.value=!0},100)):(S.value=0,w.value=0,z.value=!1,I.value=!1,setTimeout(()=>{Z()},100))):(h.value=!1,m.value=!1,d.value=!1,c.value=!1,$.value.forEach(e=>{clearTimeout(e)}),$.value=[],setTimeout(()=>{if(V.value=!1,B("closed"),o.value&&o.value.closeConnection)try{o.value.closeConnection().catch(e=>{console.error("关闭设备流连接失败:",e)})}catch(e){console.error("调用关闭设备流连接方法失败:",e)}},200))}),ae(()=>k.deviceId,(t,e)=>{t!==e&&V.value&&h.value&&(m.value=!1,d.value=!1,g.value="",c.value=!0,S.value=0,w.value=0,z.value=!1,I.value=!1,x.value=!1,setTimeout(()=>{h.value=!1,setTimeout(()=>{J()?(c.value=!1,I.value=!0,h.value=!0):Z()},50)},50))});const re=t=>{const e=x.value?"landscape":"portrait";if(x.value=t.orientation==="landscape",t.width&&t.height){const u=window.innerWidth*.9,E=window.innerHeight*.8,_=u/t.width,W=E/t.height,R=Math.min(_,W,1);S.value=Math.round(t.width*R),w.value=Math.round(t.height*R)}else{const{width:u,height:E}=O();S.value=u,w.value=E,z.value=!0}m.value&&e!==t.orientation&&s.info(`设备 ${k.deviceId} 切换到${x.value?"横屏":"竖屏"}模式`),de(t);const n=document.querySelector(".device-stream-container");n&&window.getComputedStyle(n)},de=t=>{C.value&&(t.orientation==="landscape"?x.value=!0:x.value=!1)},ee=()=>{o.value&&o.value.retryConnect&&(c.value=!0,setTimeout(()=>{d.value=!1,g.value=""},100),o.value.retryConnect())},ve=(t,e)=>{if(m.value=!0,d.value=!1,e&&e.videoReceived)c.value=!1;else if(e&&e.initialConnect){const n=window.setTimeout(()=>{c.value&&m.value&&(console.warn("长时间未收到视频数据"),c.value=!1,d.value=!0,g.value="未收到视频数据，请检查设备连接状态")},5e3);$.value.push(n)}else c.value=!1;o.value&&o.value.getWebSocketConnection&&(p.value=o.value.getWebSocketConnection())},ce=t=>{d.value=!0,c.value=!1,g.value=t.error||"连接失败"},te=()=>{d.value=!1,g.value="",c.value=!1,$.value.forEach(t=>{clearTimeout(t)}),$.value=[],B("update:modelValue",!1)},fe=t=>{if(!C.value)return;H.value=!0;const e=C.value.getBoundingClientRect();C.value.style.top=`${e.top}px`,C.value.style.left=`${e.left}px`,C.value.style.transform="none",K.value={x:t.clientX-e.left,y:t.clientY-e.top},document.addEventListener("mousemove",j),document.addEventListener("mouseup",Y)},j=t=>{if(!H.value||!C.value)return;const e=t.clientX-K.value.x,n=t.clientY-K.value.y;C.value.style.left=`${e}px`,C.value.style.top=`${n}px`},Y=()=>{H.value=!1,document.removeEventListener("mousemove",j),document.removeEventListener("mouseup",Y)},$=i([]);Ve(()=>{document.removeEventListener("mousemove",j),document.removeEventListener("mouseup",Y),window.removeEventListener("resize",le),$.value.forEach(t=>{clearTimeout(t)})}),F({retryConnection:ee});const me=t=>{c.value=!0,m.value=!1,d.value=!1};ze(()=>{window.addEventListener("resize",le)});const le=()=>{if(V.value&&!m.value){const{width:t,height:e}=O();S.value=t,w.value=e,z.value=!0}},pe=()=>{o.value&&o.value.sendNavigationCommand?(o.value.sendNavigationCommand("home"),s.success("已发送主页命令")):s.warning("设备流不可用，无法执行操作")},ge=()=>{o.value&&o.value.sendNavigationCommand?(o.value.sendNavigationCommand("back"),s.success("已发送返回命令")):s.warning("设备流不可用，无法执行操作")},Ce=()=>{o.value&&o.value.sendNavigationCommand?(o.value.sendNavigationCommand("overview"),s.success("已发送任务栏命令")):s.warning("设备流不可用，无法执行操作")},we=()=>q(null,null,function*(){if(!p.value||p.value.readyState!==WebSocket.OPEN){s.warning("设备流不可用，无法获取剪贴板内容");return}try{const e=yield new Promise((n,u)=>{const E=_=>{document.removeEventListener("device-clipboard",E),n(_.detail.text)};document.addEventListener("device-clipboard",E),setTimeout(()=>{document.removeEventListener("device-clipboard",E),u(new Error("获取剪贴板超时"))},5e3),Ae(p.value)});if(!e){s.warning("设备剪贴板内容为空");return}yield navigator.clipboard.writeText(e),se.alert(e,"设备剪贴板内容",{confirmButtonText:"确定",center:!0,customClass:"clipboard-preview"}),s.success("已复制设备剪贴板内容到本地")}catch(t){console.error("获取设备剪贴板失败:",t),s.error("获取设备剪贴板失败")}}),be=()=>q(null,null,function*(){if(!p.value||p.value.readyState!==WebSocket.OPEN){s.warning("设备流不可用，无法发送剪贴板内容");return}try{const t=yield navigator.clipboard.readText();if(!t){s.warning("本地剪贴板内容为空");return}se.confirm(`是否将以下内容发送到设备并粘贴？
${t.length>50?t.substring(0,50)+"...":t}`,"粘贴确认",{confirmButtonText:"粘贴",cancelButtonText:"仅复制不粘贴",type:"info",distinguishCancelAndClose:!0,closeOnClickModal:!1}).then(()=>{Q(p.value,t,!0),s.success("已发送内容到设备并粘贴")}).catch(e=>{e==="cancel"&&(Q(p.value,t,!1),s.success("已复制内容到设备剪贴板"))})}catch(t){console.error("设置设备剪贴板失败:",t),s.error("设置设备剪贴板失败")}}),ye=()=>{if(!o.value){s.warning("设备流不可用，无法进行文本输入");return}N.value="",M.value=!0},ke=()=>{if(!p.value||p.value.readyState!==WebSocket.OPEN){s.warning("设备流不可用，无法发送文本");return}if(!N.value.trim()){s.warning("请输入要发送的文本");return}const t=String(N.value);/[\u4e00-\u9fa5]/.test(t)?(Q(p.value,t,!0),s.success("中文文本已通过剪贴板发送到设备")):(Xe(p.value,t),s.success("文本已发送到设备")),M.value=!1},T=t=>{if(!o.value||!o.value.sendKeyCombination){s.warning("设备流不可用，无法发送组合键");return}o.value.sendKeyCombination(t),s.success("已发送组合键")},he=()=>{X.value=!0},xe=t=>{},Se=t=>{console.error("文件推送失败:",t)};return(t,e)=>{const n=L("el-icon"),u=L("el-button"),E=L("el-input"),_=L("el-form-item"),W=L("el-form"),R=L("el-dialog");return y.modelValue?(U(),G("div",Ye,[e[31]||(e[31]=r("div",{class:"stream-backdrop"},null,-1)),r("div",{class:ne(["stream-window",{landscape:x.value}]),ref_key:"dialogRef",ref:C},[r("div",{class:"stream-header",onMousedown:fe},[r("span",qe,oe(ie.value),1),r("button",{class:"close-button",onClick:te},[l(n,null,{default:a(()=>[l(b(De))]),_:1})])],32),c.value&&!d.value?(U(),G("div",Ge,[l(n,{class:"loading-icon"},{default:a(()=>[l(b(Ie))]),_:1}),e[16]||(e[16]=r("span",null,"正在连接中，请稍候...",-1))])):P("",!0),d.value?(U(),G("div",Qe,[l(n,{class:"error-icon"},{default:a(()=>[l(b($e))]),_:1}),r("span",null,oe(g.value),1),r("div",Je,[l(u,{type:"primary",size:"small",onClick:ee,class:"retry-button"},{default:a(()=>e[17]||(e[17]=[f(" 重试连接 ")])),_:1}),l(u,{type:"danger",size:"small",onClick:te,class:"close-error-button"},{default:a(()=>e[18]||(e[18]=[f(" 关闭窗口 ")])),_:1})])])):P("",!0),r("div",{class:ne(["phone-frame",{landscape:x.value}])},[V.value&&y.deviceId&&h.value?(U(),_e(Ke,{key:0,ref_key:"streamRef",ref:o,"device-id":y.deviceId,"auto-connect":!0,"server-url":y.serverUrl,"decoder-type":y.decoderType,onSuccess:ve,onStreamError:ce,onLoadingStart:me,onOrientationChange:re},null,8,["device-id","server-url","decoder-type"])):P("",!0)],2),r("div",Ze,[r("div",{class:"nav-button",onClick:ge,title:"返回"},[l(n,null,{default:a(()=>[l(b(Le))]),_:1})]),r("div",{class:"nav-button",onClick:pe,title:"主页"},[l(n,null,{default:a(()=>[l(b(Be))]),_:1})]),r("div",{class:"nav-button",onClick:Ce,title:"任务栏"},[l(n,null,{default:a(()=>[l(b(Me))]),_:1})]),r("div",{class:"nav-button",onClick:we,title:"从设备复制"},[l(n,null,{default:a(()=>[l(b(Ne))]),_:1})]),r("div",{class:"nav-button",onClick:be,title:"粘贴到设备"},[l(n,null,{default:a(()=>[l(b(Re))]),_:1})]),r("div",{class:"nav-button",onClick:ye,title:"文本输入"},[l(n,null,{default:a(()=>[l(b(Oe))]),_:1})]),r("div",{class:"nav-button",onClick:he,title:"文件推送"},[l(n,null,{default:a(()=>[l(b(We))]),_:1})])])],2),l(R,{modelValue:M.value,"onUpdate:modelValue":e[3]||(e[3]=v=>M.value=v),title:"输入文本",width:"300px","close-on-click-modal":!1,"append-to-body":""},{footer:a(()=>[r("div",et,[l(u,{onClick:e[2]||(e[2]=v=>M.value=!1)},{default:a(()=>e[19]||(e[19]=[f("取消")])),_:1}),l(u,{type:"primary",onClick:ke},{default:a(()=>e[20]||(e[20]=[f("发送")])),_:1})])]),default:a(()=>[l(W,null,{default:a(()=>[l(_,null,{default:a(()=>[l(E,{modelValue:N.value,"onUpdate:modelValue":e[0]||(e[0]=v=>N.value=v),type:"textarea",rows:4,placeholder:"请输入要发送的文本",onKeydown:e[1]||(e[1]=Pe(Ue(()=>{},["prevent"]),["enter"]))},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(R,{modelValue:A.value,"onUpdate:modelValue":e[14]||(e[14]=v=>A.value=v),title:"发送组合键",width:"350px","close-on-click-modal":!1,"append-to-body":""},{footer:a(()=>[r("div",lt,[l(u,{onClick:e[13]||(e[13]=v=>A.value=!1)},{default:a(()=>e[30]||(e[30]=[f("关闭")])),_:1})])]),default:a(()=>[l(W,null,{default:a(()=>[l(_,{label:"常用组合键"},{default:a(()=>[r("div",tt,[l(u,{onClick:e[4]||(e[4]=v=>T([113,31])),size:"small"},{default:a(()=>e[21]||(e[21]=[f("Ctrl+C (复制)")])),_:1}),l(u,{onClick:e[5]||(e[5]=v=>T([113,52])),size:"small"},{default:a(()=>e[22]||(e[22]=[f("Ctrl+V (粘贴)")])),_:1}),l(u,{onClick:e[6]||(e[6]=v=>T([113,32])),size:"small"},{default:a(()=>e[23]||(e[23]=[f("Ctrl+D (选择文本)")])),_:1}),l(u,{onClick:e[7]||(e[7]=v=>T([113,29])),size:"small"},{default:a(()=>e[24]||(e[24]=[f("Ctrl+A (全选)")])),_:1}),l(u,{onClick:e[8]||(e[8]=v=>T([113,50])),size:"small"},{default:a(()=>e[25]||(e[25]=[f("Ctrl+T (新标签页)")])),_:1}),l(u,{onClick:e[9]||(e[9]=v=>T([113,65])),size:"small"},{default:a(()=>e[26]||(e[26]=[f("Ctrl+S (保存)")])),_:1}),l(u,{onClick:e[10]||(e[10]=v=>T([113,48])),size:"small"},{default:a(()=>e[27]||(e[27]=[f("Ctrl+R (刷新)")])),_:1}),l(u,{onClick:e[11]||(e[11]=v=>T([113,122])),size:"small"},{default:a(()=>e[28]||(e[28]=[f("Ctrl+Home (到顶部)")])),_:1}),l(u,{onClick:e[12]||(e[12]=v=>T([113,123])),size:"small"},{default:a(()=>e[29]||(e[29]=[f("Ctrl+End (到底部)")])),_:1})])]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(je,{modelValue:X.value,"onUpdate:modelValue":e[15]||(e[15]=v=>X.value=v),"device-ids":[y.deviceId],"max-worker":1,onSuccess:xe,onError:Se},null,8,["modelValue","device-ids"])])):P("",!0)}}}),ft=He(at,[["__scopeId","data-v-c80ac845"]]);export{ft as default};
