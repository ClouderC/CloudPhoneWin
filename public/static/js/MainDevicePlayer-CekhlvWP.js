var x=(S,J,V)=>new Promise((r,m)=>{var X=w=>{try{$(V.next(w))}catch(z){m(z)}},T=w=>{try{$(V.throw(w))}catch(z){m(z)}},$=w=>w.done?r(w.value):Promise.resolve(w.value).then(X,T);$((V=V.apply(S,J)).next())});import{v as We,c as fe,bs as xe,A as ye,r as y,o as Re,p as k,E as R,q as b,G as h,H as c,R as d,Q as ae,D as L,U as pe,k as g,bt as Ve,aS as He,ab as oe,bu as he,S as F,aH as Le,aO as Ye,V as le,a8 as ne,_ as $e}from"./index-DqYxAufE.js";import{e as q,D as I,k as ze,T as Y,b as Be,m as Se,l as ge,a as Ke,i as Fe,h as Xe,j as Ue,W as Ge,M as qe,c as Je}from"./KeyboardMapping-D5a5ZElr.js";import{u as je}from"./cloudphone-BDuM8Wl3.js";import{h as Qe,i as Ze}from"./device-MWnAPMey.js";const et=["data-device-id"],tt={class:"device-header"},at={class:"device-name"},ot={class:"actions"},lt={class:"device-screen"},nt={key:0,class:"video-loading-overlay"},st={key:2,class:"stream-error"},it={class:"error-content-wrapper"},rt={class:"error-text"},ct={key:3,class:"video-loading-overlay"},ut={key:4,class:"offline-placeholder"},dt={class:"image-error"},vt={key:5,class:"video-loading-overlay"},ft={class:"device-footer"},yt={class:"device-id"},pt={class:"device-actions"},ht=We({__name:"MainDevicePlayer",props:{device:{type:Object,required:!0},isMainDevice:{type:Boolean,default:!0},syncEnabled:{type:Boolean,default:!0},preferredDecoderType:{type:String,default:"webcodecs"}},emits:["sync-change","stream-error","stream-success","touch-event","navigation-event","key-event","text-event"],setup(S,{expose:J,emit:V}){Ye(e=>({"48adc953":T.value?g(I).SYNC.CANVAS_LANDSCAPE.WIDTH+"px":g(I).SYNC.CANVAS_PORTRAIT.WIDTH+"px",bba3f5ce:T.value?g(I).SYNC.CANVAS_LANDSCAPE.HEIGHT+"px":g(I).SYNC.CANVAS_PORTRAIT.HEIGHT+"px"}));const r=S,m=V,X=je(),T=fe(()=>X.isLandscape),$=()=>{X.toggleOrientation(),w()},w=()=>{if(a.value&&a.value.readyState===WebSocket.OPEN){const e=I.VIDEO_SETTINGS,t={type:"videoSettings",data:{bitrate:e.BITRATE,maxFps:e.MAX_FPS,iFrameInterval:e.I_FRAME_INTERVAL,bounds:{width:e.BOUNDS.WIDTH,height:e.BOUNDS.HEIGHT},sendFrameMeta:e.SEND_FRAME_META,lockedVideoOrientation:T.value?1:0,displayId:e.DISPLAY_ID}};a.value.send(JSON.stringify(t))}},z=xe(()=>{w()},300);ye(T,(e,t)=>{e!==t&&(u.value&&typeof u.value.resetPlayerState=="function"&&u.value.resetPlayerState(),z())});const A=y(r.syncEnabled),f=y(!1),p=y(!1),i=y(null),a=y(null),B=y(null),u=y(null),P=y(!1),H=y({x:0,y:0}),se=y({x:0,y:0}),M=y(!1),U=y(!0);ye(()=>r.syncEnabled,e=>{A.value=e});const me=()=>{const e=!A.value;A.value=e,m("sync-change",e)},j=fe(()=>T.value?{width:I.SYNC.CANVAS_LANDSCAPE.WIDTH,height:I.SYNC.CANVAS_LANDSCAPE.HEIGHT}:{width:I.SYNC.CANVAS_PORTRAIT.WIDTH,height:I.SYNC.CANVAS_PORTRAIT.HEIGHT}),N=y({width:0,height:0}),we=(e,t)=>{if(N.value.width<=0||N.value.height<=0)return console.warn("目标屏幕尺寸无效，使用原始坐标"),{x:e,y:t};const l=N.value.width/j.value.width,o=N.value.height/j.value.height,n=Math.round(e*l),v=Math.round(t*o);return{x:n,y:v}},ie=()=>{if(u.value){if(typeof u.value.videoWidth!="undefined"&&typeof u.value.videoHeight!="undefined"){const e=u.value.videoWidth,t=u.value.videoHeight;if(e>0&&t>0)return{width:e,height:t}}if(B.value){const e=B.value.querySelector("canvas");if(e&&e.width&&e.height)return{width:e.width,height:e.height}}}return null},O=(e,t,l)=>{if(!a.value||a.value.readyState!==WebSocket.OPEN){console.warn("WebSocket连接不可用，无法发送触摸事件");return}if(N.value.width<=0||N.value.height<=0){const E=ie();E&&E.width>0&&E.height>0?G(E.width,E.height):console.warn("目标屏幕尺寸无效，使用原始坐标发送触摸事件")}const o=j.value,n=Math.min(Math.max(0,t),o.width),v=Math.min(Math.max(0,l),o.height),{x:s,y:C}=we(n,v);ze(a.value,e,s,C),m("touch-event",{action:e,x:t,y:l,deviceId:r.device.deviceId})},_e=e=>{M.value=!0,se.value={x:e.offsetX,y:e.offsetY},H.value={x:e.offsetX,y:e.offsetY},O(Y.DOWN,e.offsetX,e.offsetY)},be=e=>{M.value&&(H.value={x:e.offsetX,y:e.offsetY},O(Y.MOVE,e.offsetX,e.offsetY))},re=e=>{M.value&&(M.value=!1,O(Y.UP,e.offsetX,e.offsetY))},Ie=e=>{e.preventDefault(),M.value=!0;const t=e.touches[0],o=e.target.getBoundingClientRect(),n=t.clientX-o.left,v=t.clientY-o.top;se.value={x:n,y:v},H.value={x:n,y:v},O(Y.DOWN,n,v)},Te=e=>{if(e.preventDefault(),!M.value)return;const t=e.touches[0],o=e.target.getBoundingClientRect(),n=t.clientX-o.left,v=t.clientY-o.top;H.value={x:n,y:v},O(Y.MOVE,n,v)},Ce=e=>{e.preventDefault(),M.value&&(M.value=!1,O(Y.UP,H.value.x,H.value.y))},G=(e,t)=>{e>0&&t>0&&(N.value={width:e,height:t})},Ee=(e,t)=>{if(!(!U.value||t.isClosed)){if(typeof e.data=="string"){try{const l=JSON.parse(e.data);Fe(l,{onVideoSize:(o,n)=>{G(o,n)},onConnected:o=>{o&&o.screenWidth&&o.screenHeight&&G(o.screenWidth,o.screenHeight)},onDisconnected:o=>{console.warn("设备连接已断开:",o)},onError:o=>{console.error("设备连接错误:",o),i.value=o||"未知错误"}})}catch(l){}return}if(e.data instanceof ArrayBuffer&&!Xe(e.data,{onInitialMessage:o=>{if(!t._videoSettingsSent){const n=I.VIDEO_SETTINGS,v={type:"videoSettings",data:{bitrate:n.BITRATE,maxFps:n.MAX_FPS,iFrameInterval:n.I_FRAME_INTERVAL,bounds:{width:n.BOUNDS.WIDTH,height:n.BOUNDS.HEIGHT},sendFrameMeta:n.SEND_FRAME_META,lockedVideoOrientation:T.value?1:0,displayId:n.DISPLAY_ID}};t.send(JSON.stringify(v)),t._videoSettingsSent=!0}},onDeviceMessage:(o,n)=>{Je(o,n)}})){P.value||(P.value=!0);try{if(!u.value||!U.value)return;const o=new Uint8Array(e.data);u.value.pushFrame(o),t.frameCount?t.frameCount++:(t.frameCount=1,setTimeout(()=>{if(u.value&&U.value){const n=ie();n&&n.width>0&&n.height>0&&G(n.width,n.height)}},100))}catch(o){console.error("处理视频帧出错:",o)}}}},Q=()=>x(null,null,function*(){if(u.value&&(u.value.stop(),u.value=null),!B.value)return console.error("[MainDevicePlayer] Player container is not available."),i.value="播放器容器丢失",!1;let e,t="";if(r.preferredDecoderType==="webcodecs"&&window.VideoDecoder)e=Ge,t="WebCodecs";else if(r.preferredDecoderType==="mse"||!window.VideoDecoder)e=qe,t="MSE",r.preferredDecoderType==="webcodecs"&&!window.VideoDecoder&&console.warn("[MainDevicePlayer] WebCodecs not supported, falling back to MSE.");else return console.error(`[MainDevicePlayer] Unknown or unsupported decoder type: ${r.preferredDecoderType}`),i.value=`不支持的解码器: ${r.preferredDecoderType}`,!1;try{return u.value=new e,u.value.setParent(B.value),P.value=!1,!0}catch(l){return console.error(`[MainDevicePlayer] Error initializing ${t} player:`,l),i.value=`${t} 播放器初始化失败: ${l instanceof Error?l.message:"未知错误"}`,u.value=null,!1}}),ce=(e,t)=>x(null,null,function*(){if(!r.device||r.device.status!=="online"){i.value="设备不在线";return}if(t){i.value=t,p.value=!1;return}e||console.warn("startStream 被调用但没有提供端口，可能需要通过 retryStream。设备:",r.device.deviceId),p.value=!0,i.value=null,P.value=!1;try{let l=e;if(!l){if(!ue.value){i.value="启动串流失败：未提供有效端口。",p.value=!1;return}return}if(f.value=!0,yield le(),!(yield Q())){console.error("播放器初始化失败 device:",r.device.deviceId),f.value=!1,yield K(!1,!0);return}const v=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws/wsscrcpy?udid=${r.device.deviceId}&port=${l}`;if(a.value)try{a.value.isClosed=!0,a.value.onmessage=null,a.value.onerror=null,a.value.onclose=null,a.value.close()}catch(D){console.warn("关闭旧WebSocket连接出错:",D)}const s=new WebSocket(v);s.isClosed=!1,a.value=s,s.binaryType="arraybuffer";const C=setTimeout(()=>{s.readyState!==WebSocket.OPEN&&!s.isClosed&&(i.value="WebSocket连接超时",s.isClosed=!0,s.close(),K(!1,!0))},15e3);s.onopen=()=>x(null,null,function*(){if(s.isClosed)return;if(clearTimeout(C),yield le(),!(yield Q())){console.error("[MainDevicePlayer] Player initialization failed after WebSocket connected. Device:",r.device.deviceId),p.value=!1;return}if(u.value&&typeof u.value.play=="function")try{u.value.play()}catch(te){console.error(`[MainDevicePlayer ${r.device.deviceId}] Error calling player.play():`,te),i.value=`播放器启动失败: ${te instanceof Error?te.message:"未知错误"}`,p.value=!1;return}else{console.warn(`[MainDevicePlayer ${r.device.deviceId}] Player instance or play method not available.`),i.value="播放器实例或播放方法无效",p.value=!1;return}f.value=!0,p.value=!1,i.value=null,m("stream-success",r.device.deviceId)});let E=!1;const ee=setTimeout(()=>{!E&&!s.isClosed&&(i.value="未收到视频数据",K(!1,!0))},1e4);s.onmessage=D=>{s.isClosed||(E||(E=!0,clearTimeout(ee)),Ee(D,s))},s.onerror=D=>{s.isClosed||(clearTimeout(C),clearTimeout(ee),console.error("WebSocket Error:",D),i.value="WebSocket连接错误",K(!1,!0))},s.onclose=D=>{s.isClosed||(clearTimeout(C),clearTimeout(ee),s.isClosed=!0,f.value&&(i.value=i.value||`WebSocket连接已关闭 (code: ${D.code}, reason: ${D.reason||"无"})`,f.value=!1))}}catch(l){console.error("启动流过程中发生代码错误:",l),i.value=l instanceof Error?l.message:"启动流时发生未知代码错误",f.value=!1}finally{p.value=!1,ue.value=!1}}),ue=y(!1),de=()=>x(null,null,function*(){if(i.value=null,f.value=!0,p.value=!0,P.value=!1,yield le(),u.value&&u.value.stop(),!(yield Q())){console.error("[MainDevicePlayer] Player initialization failed during retry."),p.value=!1;return}if(a.value&&a.value.readyState===WebSocket.OPEN)w();else{a.value&&(a.value.onclose=null,a.value.close(),a.value=null);try{const t=yield Qe([r.device.deviceId]);if(t.code===0&&t.data&&t.data.results){const l=t.data.results[r.device.deviceId];l&&l.success&&l.port?yield ce(l.port):i.value=(l==null?void 0:l.error)||"重试获取端口失败"}else i.value=`重试API失败: ${t.message||"未知错误"}`}catch(t){console.error("[MainDevicePlayer] Error during retry API call:",t),i.value=`重试请求错误: ${t instanceof Error?t.message:"未知客户端错误"}`}}p.value=!1}),K=(e=!1,t=!1)=>x(null,null,function*(){var o,n,v;if(P.value=!1,a.value){a.value.isClosed=!0;try{a.value.onmessage=null,a.value.onerror=null,(!t||e)&&(a.value.onclose=null),a.value.close()}catch(s){console.warn("关闭WebSocket连接出错（内部调用）:",s)}a.value=null}if(u.value){try{u.value.stop()}catch(s){console.warn("停止播放器出错（内部调用）:",s)}u.value=null}if((f.value||e||!t)&&((o=r.device)!=null&&o.deviceId))try{const s=yield Ze([r.device.deviceId]),C=(v=(n=s.data)==null?void 0:n.results)==null?void 0:v[r.device.deviceId];s.code===0&&C||console.warn(`停止设备 ${r.device.deviceId} 串流后端可能失败:`,s.message||"未知错误")}catch(s){console.error("调用批量停止串流API失败:",s)}e?(f.value=!1,i.value=null):!t&&!i.value&&(f.value=!1),(t||i.value)&&(f.value=!1)}),De=()=>x(null,null,function*(){yield K(!0)}),Me=()=>{if(!a.value||a.value.readyState!==WebSocket.OPEN){ne.warning("设备连接不可用");return}q(a.value,"home"),m("navigation-event",{type:"home",deviceId:r.device.deviceId})},ke=()=>{if(!a.value||a.value.readyState!==WebSocket.OPEN){ne.warning("设备连接不可用");return}q(a.value,"back"),m("navigation-event",{type:"back",deviceId:r.device.deviceId})},Ae=()=>{if(!a.value||a.value.readyState!==WebSocket.OPEN){ne.warning("设备连接不可用");return}q(a.value,"overview"),m("navigation-event",{type:"overview",deviceId:r.device.deviceId})},W=y(!1),_=y({shift:!1,ctrl:!1,alt:!1,meta:!1,capsLock:!1}),Pe=e=>{W.value||(W.value=!0,e.currentTarget.focus())},ve=()=>Ue(_.value),Z=(e,t,l=0,o=0)=>{if(!a.value||a.value.readyState!==WebSocket.OPEN){console.warn("WebSocket连接不可用，无法发送按键事件");return}Be(a.value,e,t,l,o),A.value&&m("key-event",{action:e,keyCode:t,repeat:l,metaState:o})},Ne=e=>{if(!W.value)return;e.preventDefault(),e.code==="ShiftLeft"||e.code==="ShiftRight"?_.value.shift=!0:e.code==="ControlLeft"||e.code==="ControlRight"?_.value.ctrl=!0:e.code==="AltLeft"||e.code==="AltRight"?_.value.alt=!0:e.code==="MetaLeft"||e.code==="MetaRight"?_.value.meta=!0:e.code==="CapsLock"&&(_.value.capsLock=!_.value.capsLock);const t=Se(e.code);t&&Z(ge.DOWN,t,e.repeat?1:0,ve())},Oe=e=>{if(!W.value)return;e.preventDefault(),e.code==="ShiftLeft"||e.code==="ShiftRight"?_.value.shift=!1:e.code==="ControlLeft"||e.code==="ControlRight"?_.value.ctrl=!1:e.code==="AltLeft"||e.code==="AltRight"?_.value.alt=!1:(e.code==="MetaLeft"||e.code==="MetaRight")&&(_.value.meta=!1);const t=Se(e.code);t&&Z(ge.UP,t,0,ve())};return J({startStream:ce,stopStream:De,retryStream:de,sendTouchEvent:O,sendSpecialKey:e=>{a.value&&a.value.readyState===WebSocket.OPEN&&q(a.value,e)},getConnectionStatus:()=>a.value&&a.value.readyState===WebSocket.OPEN,isKeyboardEnabled:()=>W.value,activateKeyboard:()=>{W.value=!0},deactivateKeyboard:()=>{W.value=!1},sendKeyEvent:Z,sendText:e=>{if(!a.value||a.value.readyState!==WebSocket.OPEN||!e){console.warn("WebSocket连接不可用或文本为空，无法发送文本输入事件");return}const t=String(e);Ke(a.value,t),A.value&&m("text-event",{text:t})},showError:e=>{i.value=e,p.value=!1,f.value=!1}}),Re(()=>{U.value=!0}),(e,t)=>{const l=L("el-tooltip"),o=L("el-icon"),n=L("el-button"),v=L("el-dropdown-item"),s=L("el-dropdown-menu"),C=L("el-dropdown");return S.device?(b(),k("div",{key:0,class:"device-card main-device",tabindex:"0","data-device-id":S.device.deviceId,onKeydown:Ne,onKeyup:Oe,onMousedown:Pe},[h("div",tt,[c(l,{content:S.device.name,placement:"top",enterable:!0,"hide-after":1e3,"popper-class":"copyable-tooltip"},{default:d(()=>[h("span",at,ae(S.device.name),1)]),_:1},8,["content"]),h("div",ot,[S.isMainDevice?(b(),pe(l,{key:0,content:T.value?"切换到竖屏":"切换到横屏",placement:"top"},{default:d(()=>[c(n,{type:"default",size:"small",onClick:$,class:"orientation-button"},{default:d(()=>[c(o,null,{default:d(()=>[c(g(Ve))]),_:1})]),_:1})]),_:1},8,["content"])):R("",!0),S.isMainDevice?(b(),pe(l,{key:1,content:A.value?"关闭操作同步":"开启操作同步",placement:"top"},{default:d(()=>[c(n,{type:A.value?"primary":"default",size:"small",disabled:p.value,onClick:me,class:"sync-button"},{default:d(()=>[c(o,null,{default:d(()=>[c(g(He))]),_:1})]),_:1},8,["type","disabled"])]),_:1},8,["content"])):R("",!0)])]),h("div",lt,[f.value&&!i.value?(b(),k("div",{key:0,class:"touch-layer",onMousedown:_e,onMousemove:be,onMouseup:re,onMouseleave:re,onTouchstart:Ie,onTouchmove:Te,onTouchend:Ce},null,32)):R("",!0),f.value&&!i.value?(b(),k("div",{key:1,ref_key:"playerContainer",ref:B,class:"player-container"},[P.value?R("",!0):(b(),k("div",nt,[c(o,{class:"loading-icon"},{default:d(()=>[c(g(oe))]),_:1}),t[0]||(t[0]=h("span",null,"视频加载中...",-1))]))],512)):R("",!0),i.value?(b(),k("div",st,[h("div",it,[c(o,null,{default:d(()=>[c(g(he))]),_:1}),h("span",rt,ae(i.value),1)]),c(n,{size:"small",type:"primary",onClick:de,class:"retry-button"},{default:d(()=>t[1]||(t[1]=[F(" 重试 ")])),_:1})])):p.value&&!f.value?(b(),k("div",ct,[c(o,{class:"loading-icon"},{default:d(()=>[c(g(oe))]),_:1}),t[2]||(t[2]=h("span",null,"视频加载中...",-1))])):!f.value&&S.device.status!=="online"?(b(),k("div",ut,[h("div",dt,[c(o,null,{default:d(()=>[c(g(he))]),_:1}),t[3]||(t[3]=h("span",null,"设备离线",-1))])])):S.device.status==="online"&&!i.value&&!f.value&&!p.value?(b(),k("div",vt,[c(o,{class:"loading-icon"},{default:d(()=>[c(g(oe))]),_:1}),t[4]||(t[4]=h("span",null,"视频加载中...",-1))])):R("",!0)]),h("div",ft,[c(l,{content:"ID: "+S.device.deviceId,placement:"top",enterable:!0,"hide-after":1e3,"popper-class":"copyable-tooltip"},{default:d(()=>[h("div",yt,ae(S.device.deviceId),1)]),_:1},8,["content"]),h("div",pt,[c(C,{trigger:"click"},{dropdown:d(()=>[c(s,null,{default:d(()=>[c(v,{onClick:Me},{default:d(()=>t[6]||(t[6]=[F("主页")])),_:1}),c(v,{onClick:ke},{default:d(()=>t[7]||(t[7]=[F("返回")])),_:1}),c(v,{onClick:Ae},{default:d(()=>t[8]||(t[8]=[F("任务管理")])),_:1})]),_:1})]),default:d(()=>[c(n,{plain:"",size:"small"},{default:d(()=>[t[5]||(t[5]=F(" 操作 ")),c(o,{class:"el-icon--right"},{default:d(()=>[c(g(Le))]),_:1})]),_:1})]),_:1})])])],40,et)):R("",!0)}}}),Tt=$e(ht,[["__scopeId","data-v-05e9adcf"]]);export{Tt as default};
